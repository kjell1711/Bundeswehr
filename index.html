<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bundeswehr RP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>

        <script>
    // EINFACHE FUNKTIONEN ZUERST DEFINIEREN
    function login() {
        alert('Login funktioniert!');
    }
    
    function showApplicationForm() {
        alert('Bewerbung funktioniert!');
    }
</script>
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#f5f5f7',
                            card: '#ffffff',
                            primary: '#007aff',
                            secondary: '#5856d6',
                            success: '#34c759',
                            warning: '#ff9500',
                            danger: '#ff3b30',
                            text: '#1d1d1f',
                            'text-secondary': '#8e8e93',
                            border: '#d1d1d6'
                        },
                        bw: {
                            green: '#006400',
                            olive: '#556b2f',
                            gray: '#4a4a4a',
                            dark: '#2c2c2e'
                        }
                    },
                    borderRadius: {
                        'ios': '12px',
                        'ios-sm': '8px',
                        'ios-lg': '16px',
                        'ios-xl': '20px'
                    },
                    boxShadow: {
                        'ios': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'ios-lg': '0 10px 40px rgba(0, 0, 0, 0.1)',
                        'ios-xl': '0 20px 60px rgba(0, 0, 0, 0.12)'
                    },
                    backdropBlur: {
                        'ios': '20px'
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Modern iOS Design */
        * {
            transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
        }
        
        body {
            background-color: #f5f5f7;
        }
        
        .ios-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .bw-card {
            background: white;
            border: 1px solid #e5e5e7;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #006400, #008000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #007aff, #0056cc);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #34c759, #2d9950);
        }
        
        .gradient-bw {
            background: linear-gradient(135deg, #006400, #004d00);
        }
        
        .soldier-id-badge {
            background: linear-gradient(135deg, #1d1d1f, #2c2c2e);
            color: white;
        }
        
        .stamina-badge {
            background: linear-gradient(135deg, #ff9500, #e68500);
            color: white;
        }
        
        .rank-badge {
            background: linear-gradient(135deg, #5856d6, #4a48b8);
            color: white;
        }
        
        /* Smooth animations */
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Collapsible sidebar */
        .sidebar-collapsed {
            width: 70px;
        }
        
        .sidebar-expanded {
            width: 250px;
        }
        
        .main-expanded {
            margin-left: 250px;
        }
        
        .main-collapsed {
            margin-left: 70px;
        }
        
        @media (max-width: 768px) {
            .sidebar-expanded, .sidebar-collapsed {
                width: 100%;
                position: fixed;
                z-index: 1000;
                height: auto;
                bottom: 0;
                top: auto;
                border-right: none;
                border-top: 1px solid #e5e5e7;
            }
            
            .main-expanded, .main-collapsed {
                margin-left: 0;
                margin-bottom: 70px;
            }
        }
        
        /* Military ID Card */
        .military-id {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .military-id::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 100, 0, 0.1) 0%, transparent 70%);
        }
        
        .military-id-header {
            background: rgba(0, 100, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .id-number {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Mission Card */
        .mission-card {
            border-left: 4px solid #007aff;
        }
        
        .mission-active {
            border-left-color: #34c759;
        }
        
        .mission-completed {
            border-left-color: #8e8e93;
        }
        
        /* Application Status */
        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
            border: 1px solid rgba(255, 149, 0, 0.2);
        }
        
        .status-accepted {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        /* Stamina Indicator */
        .stamina-low { color: #ff3b30; }
        .stamina-medium { color: #ff9500; }
        .stamina-high { color: #34c759; }
        
        .stamina-bar-low { background: #ff3b30; }
        .stamina-bar-medium { background: #ff9500; }
        .stamina-bar-high { background: #34c759; }
    </style>
</head>
<body class="bg-ios-bg text-ios-text font-sans min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 gradient-bg">
        <div class="ios-card rounded-ios-xl shadow-ios-xl p-6 sm:p-8 w-full max-w-md">
            <!-- Logo -->
            <div class="w-24 h-24 sm:w-28 sm:h-28 mx-auto mb-6 rounded-2xl gradient-bw flex items-center justify-center shadow-lg">
                <i class="fas fa-shield-alt text-white text-4xl"></i>
            </div>
            
            <h1 class="text-3xl font-bold text-center mb-2 gradient-text">Bundeswehr RP</h1>
            <p class="text-ios-text-secondary text-center mb-8">Militärisches Rollenspiel Management</p>
            
            <!-- Login Form -->
            <div class="space-y-4" id="loginForm">
                <div>
                    <label class="block text-sm font-medium mb-2 text-bw-gray">Benutzername</label>
                    <input type="text" id="loginUsername" 
                           class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                           placeholder="Benutzername">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2 text-bw-gray">Passwort</label>
                    <input type="password" id="loginPassword" 
                           class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                           placeholder="••••••••">
                </div>
                
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="loginErrorText">Falscher Benutzername oder Passwort</span>
                </div>
                
                <button onclick="login()" class="w-full gradient-bw text-white py-3 rounded-ios-sm font-semibold text-lg hover:shadow-lg transition-shadow">
                    <i class="fas fa-sign-in-alt mr-2"></i>Einloggen
                </button>
            </div>
            
            <!-- Application Button -->
            <div class="mt-6 pt-6 border-t border-ios-border">
                <button onclick="showApplicationForm()" class="w-full bg-white border-2 border-bw-green text-bw-green py-3 rounded-ios-sm font-semibold text-lg hover:bg-bw-green hover:text-white transition-colors">
                    <i class="fas fa-file-alt mr-2"></i>Bewerben
                </button>
            </div>
            
            <div class="mt-8 pt-6 border-t border-ios-border text-center text-ios-text-secondary text-sm">
                <p><i class="fas fa-shield-alt mr-2"></i>Offizielles Bundeswehr RP System</p>
            </div>
        </div>
    </div>

    <!-- Application Form (Hidden initially) -->
    <div id="applicationForm" class="hidden min-h-screen flex items-center justify-center p-4 bg-gray-50">
        <div class="ios-card rounded-ios-xl shadow-ios-xl p-6 w-full max-w-2xl">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold gradient-text">Bewerbung</h2>
                    <p class="text-ios-text-secondary">Bewerben Sie sich für die Bundeswehr</p>
                </div>
                <button onclick="showLoginForm()" class="text-ios-text-secondary hover:text-ios-text">
                    <i class="fas fa-arrow-left"></i> Zurück
                </button>
            </div>
            
            <div id="applicationContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-ios-border px-4 sm:px-6 py-3 flex items-center justify-between sticky top-0 z-40">
            <!-- Left: Hamburger menu and ID button -->
            <div class="flex items-center gap-3">
                <button onclick="toggleSidebar()" class="text-ios-text-secondary hover:text-ios-text p-2">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                
                <button onclick="showMilitaryID()" class="flex items-center gap-2 text-ios-text hover:text-ios-primary">
                    <i class="fas fa-id-card"></i>
                    <span class="hidden sm:inline text-sm font-medium">Ausweis</span>
                </button>
            </div>
            
            <!-- Center: Time -->
            <div class="flex items-center gap-3">
                <div id="currentTime" class="font-mono font-bold text-lg">00:00</div>
                <div class="hidden sm:block text-ios-text-secondary text-sm">
                    <span id="currentDate">01.01.2024</span>
                </div>
            </div>
            
            <!-- Right: User info and logout -->
            <div class="flex items-center gap-3">
                <div id="userStaminaBadge" class="hidden sm:flex items-center gap-2 bg-orange-50 px-3 py-1.5 rounded-full border border-orange-100">
                    <i class="fas fa-fire text-orange-500"></i>
                    <span class="font-semibold text-sm text-orange-700">
                        Ausdauer: <span id="staminaValue">0</span>
                    </span>
                </div>
                
                <div class="hidden sm:flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-bw-green flex items-center justify-center text-white font-bold text-sm">
                        <span id="userInitials">BW</span>
                    </div>
                    <div>
                        <div id="userName" class="font-medium text-sm">Lade...</div>
                        <div id="userRankSmall" class="text-xs text-ios-text-secondary">Rang: -</div>
                    </div>
                </div>
                
                <button onclick="logout()" class="text-red-500 hover:text-red-700 p-2" title="Ausloggen">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar-expanded bg-white border-r border-ios-border h-[calc(100vh-64px)] overflow-y-auto hide-scrollbar fixed left-0 top-16 transition-all duration-300">
            <!-- User Profile -->
            <div class="p-4 border-b border-ios-border">
                <div class="flex items-center gap-3 mb-3">
                    <div id="userAvatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-bw-green to-bw-olive flex items-center justify-center text-white font-bold">
                        BW
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="userDisplayName" class="font-bold truncate">Lade...</div>
                        <div id="userDivision" class="text-sm text-ios-text-secondary truncate">Division: -</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="text-center p-2 bg-gray-50 rounded-ios-sm">
                        <div class="text-xs text-ios-text-secondary">Rang</div>
                        <div id="userRank" class="font-semibold">-</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 rounded-ios-sm">
                        <div class="text-xs text-ios-text-secondary">ID</div>
                        <div id="userID" class="font-mono text-sm">#0000</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-2">
                <div class="space-y-1">
                    <button onclick="showPage('dashboard')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-home w-5 text-center"></i>
                        <span>Dashboard</span>
                    </button>
                    
                    <button onclick="showPage('missions')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-crosshairs w-5 text-center"></i>
                        <span>Einsätze</span>
                    </button>
                    
                    <button onclick="showPage('personnel')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-users w-5 text-center"></i>
                        <span>Personal</span>
                    </button>
                    
                    <div id="managementSection" class="hidden">
                        <div class="text-xs font-semibold text-ios-text-secondary uppercase tracking-wider px-4 py-2">Leitung</div>
                        
                        <button onclick="showPage('management')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                            <i class="fas fa-tasks w-5 text-center"></i>
                            <span>Management</span>
                        </button>
                        
                        <button onclick="showPage('applications')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                            <i class="fas fa-file-alt w-5 text-center"></i>
                            <span>Bewerbungen</span>
                            <span id="pendingAppsBadge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </div>
                    
                    <button onclick="showPage('settings')" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-cog w-5 text-center"></i>
                        <span>Einstellungen</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-expanded p-4 sm:p-6 transition-all duration-300 min-h-[calc(100vh-64px)]">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Dashboard</h1>
                    <p class="text-ios-text-secondary">Willkommen bei der Bundeswehr</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Military ID Card -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold">Truppenausweis</h2>
                            <button onclick="showMilitaryID()" class="text-ios-primary hover:text-ios-primary/80">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Name:</span>
                                <span id="idName" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstgrad:</span>
                                <span id="idRank" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Einheit:</span>
                                <span id="idUnit" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Personalnummer:</span>
                                <span id="idNumber" class="font-mono text-sm">#0000</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstbeginn:</span>
                                <span id="idStartDate" class="font-semibold">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stamina -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <h2 class="text-lg font-bold mb-4">Ausdauer</h2>
                        <div class="text-center mb-4">
                            <div class="text-4xl font-bold mb-2">
                                <span id="dashboardStamina">0</span>
                                <span class="text-2xl text-ios-text-secondary">/∞</span>
                            </div>
                            <div class="text-ios-text-secondary text-sm">
                                Trainingspunkte
                            </div>
                        </div>
                        <div class="text-sm text-ios-text-secondary">
                            <i class="fas fa-info-circle mr-1"></i>
                            Erhalten durch Training mit Ausbildern
                        </div>
                    </div>
                    
                    <!-- Service Info -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <h2 class="text-lg font-bold mb-4">Dienstinformationen</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstzeit:</span>
                                <span id="serviceTime" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Status:</span>
                                <span id="serviceStatus" class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Aktiv</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Letzte Beförderung:</span>
                                <span id="lastPromotion" class="font-semibold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Missions -->
                <div class="ios-card rounded-ios-lg p-5 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Bevorstehende Einsätze</h2>
                        <button onclick="showPage('missions')" class="text-sm text-ios-primary hover:text-ios-primary/80 font-medium">
                            Alle ansehen →
                        </button>
                    </div>
                    
                    <div id="upcomingMissions" class="space-y-3">
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                            <p>Keine bevorstehenden Einsätze</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missions Page -->
            <div id="missionsPage" class="page hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Einsätze</h1>
                        <p class="text-ios-text-secondary">Aktive und geplante Missionen</p>
                    </div>
                    <button id="createMissionBtn" onclick="showCreateMissionModal()" class="hidden gradient-bw text-white px-4 py-2 rounded-ios-sm font-semibold hover:shadow-lg">
                        <i class="fas fa-plus mr-2"></i>Neuer Einsatz
                    </button>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <!-- Mission Tabs -->
                    <div class="flex border-b border-ios-border mb-6 -mx-5 px-5">
                        <button onclick="setMissionFilter('all')" class="mission-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="all">
                            Alle
                        </button>
                        <button onclick="setMissionFilter('active')" class="mission-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="active">
                            Aktiv
                        </button>
                        <button onclick="setMissionFilter('upcoming')" class="mission-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="upcoming">
                            Bevorstehend
                        </button>
                        <button onclick="setMissionFilter('completed')" class="mission-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="completed">
                            Abgeschlossen
                        </button>
                    </div>
                    
                    <!-- Missions List -->
                    <div id="missionsList" class="space-y-4">
                        <!-- Missions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Personnel Page -->
            <div id="personnelPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Personal</h1>
                    <p class="text-ios-text-secondary">Übersicht aller Soldaten</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <!-- Search and Filter -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-6">
                        <div class="relative flex-1">
                            <input type="text" id="personnelSearch" placeholder="Name, Rang oder ID suchen..." 
                                   class="w-full px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                            <i class="fas fa-search absolute right-3 top-3 text-ios-text-secondary"></i>
                        </div>
                        <select id="divisionFilter" class="px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20 bg-white">
                            <option value="">Alle Divisionen</option>
                            <option value="Heer">Heer</option>
                            <option value="Marine">Marine</option>
                            <option value="Luftwaffe">Luftwaffe</option>
                            <option value="Sanitätsdienst">Sanitätsdienst</option>
                        </select>
                        <select id="rankFilter" class="px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20 bg-white">
                            <option value="">Alle Ränge</option>
                            <option value="Schütze">Schütze</option>
                            <option value="Gefreiter">Gefreiter</option>
                            <option value="Obergefreiter">Obergefreiter</option>
                            <option value="Hauptgefreiter">Hauptgefreiter</option>
                            <option value="Stabsgefreiter">Stabsgefreiter</option>
                            <option value="Oberstabsgefreiter">Oberstabsgefreiter</option>
                            <option value="Unteroffizier">Unteroffizier</option>
                            <option value="Stabsunteroffizier">Stabsunteroffizier</option>
                            <option value="Feldwebel">Feldwebel</option>
                            <option value="Hauptfeldwebel">Hauptfeldwebel</option>
                        </select>
                    </div>
                    
                    <!-- Personnel List -->
                    <div id="personnelList" class="space-y-3">
                        <!-- Personnel will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Management Page -->
            <div id="managementPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Management</h1>
                    <p class="text-ios-text-secondary">Leitungsebene - Systemverwaltung</p>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <button onclick="showCreateMissionModal()" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mb-3">
                            <i class="fas fa-plus text-blue-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Neuer Einsatz</h3>
                        <p class="text-sm text-ios-text-secondary">Einsatz erstellen und planen</p>
                    </button>
                    
                    <button onclick="showPage('applications')" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-3">
                            <i class="fas fa-file-alt text-green-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Bewerbungen</h3>
                        <p class="text-sm text-ios-text-secondary">
                            <span id="pendingAppsCount2" class="font-semibold">0</span> ausstehend
                        </p>
                    </button>
                    
                    <button onclick="showCreateUserModal()" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center mb-3">
                            <i class="fas fa-user-plus text-purple-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Neuer Account</h3>
                        <p class="text-sm text-ios-text-secondary">Direkt Account erstellen</p>
                    </button>
                    
                    <button onclick="showReports()" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center mb-3">
                            <i class="fas fa-chart-bar text-orange-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Statistiken</h3>
                        <p class="text-sm text-ios-text-secondary">System-Übersicht</p>
                    </button>
                </div>
                
                <!-- Recent Activity -->
                <div class="ios-card rounded-ios-lg p-5">
                    <h2 class="text-lg font-bold mb-4">Letzte Aktivitäten</h2>
                    <div id="managementActivity" class="space-y-3">
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-history text-3xl mb-3"></i>
                            <p>Keine Aktivitäten vorhanden</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applications Page -->
            <div id="applicationsPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Bewerbungen</h1>
                    <p class="text-ios-text-secondary">Neue Bewerbungen prüfen und bearbeiten</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <!-- Application Tabs -->
                    <div class="flex border-b border-ios-border mb-6 -mx-5 px-5">
                        <button onclick="setApplicationFilter('pending')" class="app-tab px-4 py-2 font-medium border-b-2 border-bw-green text-bw-green" data-filter="pending">
                            Ausstehend (<span id="pendingCount">0</span>)
                        </button>
                        <button onclick="setApplicationFilter('accepted')" class="app-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="accepted">
                            Angenommen
                        </button>
                        <button onclick="setApplicationFilter('rejected')" class="app-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text" data-filter="rejected">
                            Abgelehnt
                        </button>
                    </div>
                    
                    <!-- Applications List -->
                    <div id="applicationsList" class="space-y-4">
                        <!-- Applications will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Einstellungen</h1>
                    <p class="text-ios-text-secondary">Persönliche Einstellungen</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <div class="space-y-6">
                        <!-- Profile Settings -->
                        <div>
                            <h2 class="text-lg font-bold mb-4">Profil</h2>
                            <div class="space-y-4 max-w-md">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Anzeigename</label>
                                    <input type="text" id="displayNameInput" 
                                           class="w-full px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                           value="Max Mustermann">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Roblox Username</label>
                                    <input type="text" id="robloxUsername" 
                                           class="w-full px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                           placeholder="Dein Roblox Name">
                                </div>
                                <button onclick="updateProfile()" class="bg-bw-green text-white px-6 py-2 rounded-ios-sm font-semibold hover:bg-green-800 transition-colors">
                                    Änderungen speichern
                                </button>
                            </div>
                        </div>
                        
                        <!-- Application Status -->
                        <div class="pt-6 border-t border-ios-border">
                            <h2 class="text-lg font-bold mb-4">Bewerbungsstatus</h2>
                            <div id="applicationStatus" class="max-w-md">
                                <!-- Application status will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Military ID Modal -->
    <div id="militaryIDModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="military-id rounded-ios-xl shadow-2xl w-full max-w-md p-0 overflow-hidden slide-in">
            <!-- ID Header -->
            <div class="military-id-header px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">BUNDESWEHR RP</h2>
                        <p class="text-sm opacity-80">Truppenausweis</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs opacity-80">Personalausweis Nr.</div>
                        <div id="modalIDNumber" class="id-number font-mono text-sm">#0000</div>
                    </div>
                </div>
            </div>
            
            <!-- ID Content -->
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <div class="text-xs opacity-80 mb-1">Name</div>
                        <div id="modalName" class="text-xl font-bold">-</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs opacity-80 mb-1">Dienstgrad</div>
                            <div id="modalRank" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-80 mb-1">Einheit</div>
                            <div id="modalUnit" class="font-semibold">-</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="text-xs opacity-80 mb-1">Personalnummer</div>
                        <div id="modalPersonnelNumber" class="font-mono">BW-<span id="modalPersonnelID">0000</span></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs opacity-80 mb-1">Dienstbeginn</div>
                            <div id="modalStartDate" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-80 mb-1">Gültig bis</div>
                            <div id="modalValidUntil" class="font-semibold">-</div>
                        </div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-white/10">
                        <div class="text-xs opacity-80 mb-2">Unterschrift des Inhabers</div>
                        <div class="h-8 border-b border-white/30"></div>
                    </div>
                </div>
            </div>
            
            <!-- ID Footer -->
            <div class="px-6 py-3 bg-black/20 text-center text-xs opacity-80">
                Dieser Ausweis ist Eigentum der Bundeswehr RP und darf nur von autorisiertem Personal verwendet werden.
            </div>
            
            <!-- Close Button -->
            <button onclick="hideMilitaryID()" class="absolute top-4 right-4 text-white/70 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Create Mission Modal -->
    <div id="createMissionModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-2xl max-h-[90vh] overflow-y-auto slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Neuer Einsatz</h2>
                    <button onclick="hideCreateMissionModal()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label class="block text-sm font-medium mb-2">Titel *</label>
                        <input type="text" id="missionTitle" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="z.B. Patrouille Grenzgebiet">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Beschreibung *</label>
                        <textarea id="missionDescription" rows="4" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Details zum Einsatz..."></textarea>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Standort *</label>
                            <input type="text" id="missionLocation" 
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                   placeholder="z.B. Übungsgelände Alpha">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Treffpunkt</label>
                            <input type="text" id="missionMeetingPoint" 
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                   placeholder="z.B. Haupttor Kaserne">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Datum *</label>
                            <input type="date" id="missionDate" 
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Uhrzeit *</label>
                            <input type="time" id="missionTime" 
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Einsatztyp</label>
                            <select id="missionType" 
                                    class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                                <option value="Patrouille">Patrouille</option>
                                <option value="Übung">Übung</option>
                                <option value="Wachdienst">Wachdienst</option>
                                <option value="Manöver">Manöver</option>
                                <option value="Ausbildung">Ausbildung</option>
                                <option value="Sondereinsatz">Sondereinsatz</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Schwierigkeit</label>
                            <select id="missionDifficulty" 
                                    class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                                <option value="Niedrig">Niedrig</option>
                                <option value="Mittel">Mittel</option>
                                <option value="Hoch">Hoch</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Planung / Ablauf</label>
                        <textarea id="missionPlan" rows="3" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Geplanter Ablauf des Einsatzes..."></textarea>
                    </div>
                    
                    <div id="missionError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte fülle alle erforderlichen Felder aus</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button onclick="createMission()" class="flex-1 gradient-bw text-white py-3 rounded-ios-sm font-semibold text-lg hover:shadow-lg">
                            <i class="fas fa-save mr-2"></i>Einsatz erstellen
                        </button>
                        <button onclick="hideCreateMissionModal()" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold text-lg hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create User Modal -->
    <div id="createUserModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Account erstellen</h2>
                    <button onclick="hideCreateUserModal()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">Vollständiger Name *</label>
                        <input type="text" id="createUserName" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="Max Mustermann">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Username *</label>
                        <input type="text" id="createUserUsername" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="max.mustermann">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Passwort *</label>
                        <input type="password" id="createUserPassword" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="••••••••">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Dienstgrad *</label>
                        <select id="createUserRank" 
                                class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                            <option value="Schütze">Schütze</option>
                            <option value="Gefreiter">Gefreiter</option>
                            <option value="Obergefreiter">Obergefreiter</option>
                            <option value="Hauptgefreiter">Hauptgefreiter</option>
                            <option value="Stabsgefreiter">Stabsgefreiter</option>
                            <option value="Oberstabsgefreiter">Oberstabsgefreiter</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Division *</label>
                        <select id="createUserDivision" 
                                class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                            <option value="Heer">Heer</option>
                            <option value="Marine">Marine</option>
                            <option value="Luftwaffe">Luftwaffe</option>
                            <option value="Sanitätsdienst">Sanitätsdienst</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Rolle</label>
                        <select id="createUserRole" 
                                class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                            <option value="soldier">Soldat</option>
                            <option value="leader">Leitung</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <div id="createUserError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte fülle alle Felder aus</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button onclick="createUser()" class="flex-1 gradient-bw text-white py-3 rounded-ios-sm font-semibold hover:shadow-lg">
                            <i class="fas fa-user-plus mr-2"></i>Account erstellen
                        </button>
                        <button onclick="hideCreateUserModal()" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Accept Application Modal -->
    <div id="acceptApplicationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Bewerbung annehmen</h2>
                    <button onclick="hideAcceptApplicationModal()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div id="acceptAppInfo">
                        <!-- Application info will be loaded here -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Username *</label>
                        <input type="text" id="acceptUsername" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="Benutzername für Login">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Passwort *</label>
                        <input type="text" id="acceptPassword" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                               placeholder="Passwort für Login" value="bundeswehr123">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Dienstgrad</label>
                        <select id="acceptRank" 
                                class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                            <option value="Schütze">Schütze</option>
                        </select>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Willkommensnachricht</label>
                        <textarea id="acceptMessage" rows="3" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Herzlich Willkommen! Dein erster Dienst beginnt am..."></textarea>
                    </div>
                    
                    <div id="acceptError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte fülle alle Felder aus</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button onclick="acceptApplicationConfirm()" class="flex-1 bg-green-600 text-white py-3 rounded-ios-sm font-semibold hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Annehmen & Account erstellen
                        </button>
                        <button onclick="hideAcceptApplicationModal()" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Application Modal -->
    <div id="rejectApplicationModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Bewerbung ablehnen</h2>
                    <button onclick="hideRejectApplicationModal()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div id="rejectAppInfo">
                        <!-- Application info will be loaded here -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Ablehnungsgrund *</label>
                        <textarea id="rejectReason" rows="3" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Bitte gib einen Grund für die Ablehnung an..."></textarea>
                    </div>
                    
                    <div id="rejectError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte gib einen Ablehnungsgrund an</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button onclick="rejectApplicationConfirm()" class="flex-1 bg-red-600 text-white py-3 rounded-ios-sm font-semibold hover:bg-red-700">
                            <i class="fas fa-times mr-2"></i>Ablehnen
                        </button>
                        <button onclick="hideRejectApplicationModal()" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Soldier Actions Modal -->
    <div id="soldierActionsModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold gradient-text" id="soldierActionsTitle">Aktionen</h2>
                    <button onclick="hideSoldierActionsModal()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div id="soldierActionsContent" class="space-y-3">
                    <!-- Actions will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="ios-card rounded-ios-xl p-8 flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="font-semibold">Lade...</p>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-3 w-80 sm:w-96"></div>

    <!-- Main JavaScript -->
    <script>
        // ======================
        // APP STATE & CONFIGURATION
        // ======================
            const APP_CONFIG = {
            appName: 'Bundeswehr RP',
            version: '1.0.0',
            localStoragePrefix: 'bw_rp_',
            defaultStamina: 0,
            applicationCooldown: 7 * 24 * 60 * 60 * 1000, // 7 Tage
            ranks: [
                'Schütze', 'Gefreiter', 'Obergefreiter', 'Hauptgefreiter',
                'Stabsgefreiter', 'Oberstabsgefreiter', 'Unteroffizier',
                'Stabsunteroffizier', 'Feldwebel', 'Hauptfeldwebel',
                'Stabsfeldwebel', 'Oberstabsfeldwebel', 'Leutnant',
                'Oberleutnant', 'Hauptmann', 'Stabshauptmann', 'Major',
                'Oberstleutnant', 'Oberst', 'Brigadegeneral',
                'Generalmajor', 'Generalleutnant', 'General'
            ],
            divisions: ['Heer', 'Marine', 'Luftwaffe', 'Sanitätsdienst']
        };

        // App State
        let currentUser = null;
        let currentPage = 'dashboard';
        let missions = [];
        let personnel = [];
        let applications = [];
        let isSidebarCollapsed = false;

        // ======================
        // INITIALIZATION
        // ======================
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });

        async function initializeApp() {
            // Check for saved session
            await checkSavedSession();
            
            // Initialize clock
            updateClock();
            setInterval(updateClock, 60000);
            
            // Setup event listeners
            setupEventListeners();
            
            // Load test data if no database
            if (!window.supabase) {
                loadTestData();
            }
            
            // Show welcome message
            setTimeout(() => {
                if (!currentUser) {
                    showNotification('Willkommen beim Bundeswehr RP System', 'info');
                }
            }, 1000);
        }

        async function checkSavedSession() {
            const savedUser = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'user');
            const savedToken = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'token');
            
            if (savedUser && savedToken) {
                try {
                    const user = JSON.parse(savedUser);
                    
                    // Check if token is still valid (simplified)
                    const tokenExpiry = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                    if (tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                        // Auto-login
                        handleLoginSuccess(user);
                        showNotification('Willkommen zurück, ' + user.display_name, 'success');
                        return true;
                    } else {
                        // Token expired
                        localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token');
                        localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                }
            }
            
            return false;
        }

        function setupEventListeners() {
            // Login form enter key
            document.getElementById('loginUsername')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            // Personnel search
            document.getElementById('personnelSearch')?.addEventListener('input', function() {
                filterPersonnel();
            });
            
            document.getElementById('divisionFilter')?.addEventListener('change', function() {
                filterPersonnel();
            });
            
            document.getElementById('rankFilter')?.addEventListener('change', function() {
                filterPersonnel();
            });
            
            // Initialize today's date for mission creation
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('missionDate')?.setAttribute('min', today);
            document.getElementById('missionDate')?.value = today;
            
            // Set mission time to next hour
            const nextHour = new Date();
            nextHour.setHours(nextHour.getHours() + 1);
            nextHour.setMinutes(0);
            document.getElementById('missionTime')?.value = 
                nextHour.getHours().toString().padStart(2, '0') + ':00';
        }

        function loadTestData() {
            // Test accounts
            const testUsers = [
                {
                    id: 'admin-001',
                    username: 'admin_test',
                    password: 'bundeswehr123',
                    display_name: 'Oberst Markus Schmidt',
                    rank: 'Oberst',
                    division: 'Heer',
                    role: 'admin',
                    stamina: 45,
                    soldier_id: 'BW-0001',
                    service_start: '2023-01-15',
                    roblox_username: 'OberstSchmidt_BW'
                },
                {
                    id: 'soldier-001',
                    username: 'soldat',
                    password: 'soldat123',
                    display_name: 'Gefreiter Thomas Weber',
                    rank: 'Gefreiter',
                    division: 'Marine',
                    role: 'soldier',
                    stamina: 12,
                    soldier_id: 'BW-0015',
                    service_start: '2023-06-10',
                    roblox_username: 'MarineWeber'
                },
                {
                    id: 'soldier-002',
                    username: 'soldat2',
                    password: 'soldat123',
                    display_name: 'Schütze Lisa Müller',
                    rank: 'Schütze',
                    division: 'Luftwaffe',
                    role: 'soldier',
                    stamina: 5,
                    soldier_id: 'BW-0023',
                    service_start: '2023-08-22',
                    roblox_username: 'LuftwaffeLisa'
                }
            ];
            
            // Test missions
            missions = [
                {
                    id: 'mission-001',
                    title: 'Patrouille Grenzgebiet Alpha',
                    description: 'Routine-Patrouille entlang der östlichen Grenze. Überwachung und Kontrolle des Grenzbereichs.',
                    location: 'Grenzgebiet Alpha, Sektor 7',
                    meeting_point: 'Kaserne Haupttor',
                    type: 'Patrouille',
                    difficulty: 'Mittel',
                    date: new Date(Date.now() + 86400000).toISOString().split('T')[0],
                    time: '14:00',
                    plan: '14:00 Treffen am Haupttor\n14:30 Abfahrt zum Grenzgebiet\n15:00 Beginn Patrouille\n17:00 Rückkehr zur Kaserne',
                    status: 'upcoming',
                    created_by: 'admin-001',
                    participants: ['soldier-001', 'soldier-002'],
                    created_at: new Date(Date.now() - 86400000).toISOString()
                },
                {
                    id: 'mission-002',
                    title: 'Übung: Nachtmanöver',
                    description: 'Taktische Übung unter Nachtbedingungen. Training von Nachtsicht und stiller Bewegung.',
                    location: 'Übungsgelände Bravo',
                    meeting_point: 'Übungsgelände Kommandostand',
                    type: 'Übung',
                    difficulty: 'Hoch',
                    date: new Date(Date.now() + 172800000).toISOString().split('T')[0],
                    time: '20:00',
                    plan: '20:00 Einweisung\n20:30 Beginn Nachtübung\n22:30 Abschlussbesprechung\n23:00 Ende',
                    status: 'upcoming',
                    created_by: 'admin-001',
                    participants: ['soldier-001'],
                    created_at: new Date(Date.now() - 43200000).toISOString()
                },
                {
                    id: 'mission-003',
                    title: 'Wachdienst Haupttor',
                    description: 'Standard-Wachdienst am Haupteingang der Kaserne.',
                    location: 'Kaserne Haupttor',
                    meeting_point: 'Wachlokal',
                    type: 'Wachdienst',
                    difficulty: 'Niedrig',
                    date: new Date().toISOString().split('T')[0],
                    time: '08:00',
                    plan: '8:00-12:00 Wachdienst Schicht 1\n12:00-16:00 Schicht 2\n16:00-20:00 Schicht 3',
                    status: 'active',
                    created_by: 'admin-001',
                    participants: [],
                    created_at: new Date(Date.now() - 86400000).toISOString()
                }
            ];
            
            // Test personnel
            personnel = testUsers.map(user => ({
                id: user.id,
                name: user.display_name,
                rank: user.rank,
                division: user.division,
                stamina: user.stamina,
                soldier_id: user.soldier_id,
                role: user.role,
                username: user.username
            }));
            
            // Test applications
            applications = [
                {
                    id: 'app-001',
                    roblox_username: 'FutureSoldier',
                    display_name: 'Max Bauer',
                    application_text: 'Ich möchte der Bundeswehr beitreten, weil ich schon immer für mein Land dienen wollte. Ich bin teamfähig und diszipliniert.',
                    age_group: '18-25',
                    preferred_division: 'Heer',
                    status: 'pending',
                    created_at: new Date(Date.now() - 86400000).toISOString(),
                    application_date: new Date(Date.now() - 86400000).toLocaleDateString('de-DE')
                },
                {
                    id: 'app-002',
                    roblox_username: 'MarineFan',
                    display_name: 'Anna Fischer',
                    application_text: 'Ich interessiere mich besonders für die Marine und möchte zur See dienen. Ich habe bereits Erfahrung mit Teamwork und bin körperlich fit.',
                    age_group: '26-35',
                    preferred_division: 'Marine',
                    status: 'pending',
                    created_at: new Date(Date.now() - 172800000).toISOString(),
                    application_date: new Date(Date.now() - 172800000).toLocaleDateString('de-DE')
                }
            ];
            
            // Store test users globally for login simulation
            window.testUsers = testUsers;
        }

        // ======================
        // UI FUNCTIONS
        // ======================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const dateStr = now.toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const timeEl = document.getElementById('currentTime');
            const dateEl = document.getElementById('currentDate');
            
            if (timeEl) timeEl.textContent = timeStr;
            if (dateEl) dateEl.textContent = dateStr;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (isSidebarCollapsed) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.remove('main-expanded');
                mainContent.classList.add('main-collapsed');
                
                // Hide text in sidebar
                sidebar.querySelectorAll('span:not(.absolute)').forEach(span => {
                    if (!span.closest('#userID')) {
                        span.classList.add('hidden');
                    }
                });
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                mainContent.classList.remove('main-collapsed');
                mainContent.classList.add('main-expanded');
                
                // Show text in sidebar
                sidebar.querySelectorAll('span').forEach(span => {
                    span.classList.remove('hidden');
                });
            }
        }

        function showPage(page) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            
            // Show selected page
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update active nav item
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-gray-50', 'text-ios-primary');
            });
            
            // Load page data
            switch(page) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'missions':
                    loadMissions();
                    break;
                case 'personnel':
                    loadPersonnel();
                    break;
                case 'management':
                    loadManagement();
                    break;
                case 'applications':
                    loadApplications();
                    break;
                case 'settings':
                    loadSettings();
                    break;
            }
            
            currentPage = page;
        }

        function setMissionFilter(filter) {
            document.querySelectorAll('.mission-tab').forEach(tab => {
                tab.classList.remove('border-b-2', 'border-bw-green', 'text-bw-green');
                tab.classList.add('border-transparent', 'text-ios-text-secondary');
            });
            
            const activeTab = document.querySelector(`.mission-tab[data-filter="${filter}"]`);
            if (activeTab) {
                activeTab.classList.add('border-b-2', 'border-bw-green', 'text-bw-green');
                activeTab.classList.remove('border-transparent', 'text-ios-text-secondary');
            }
            
            loadMissions(filter);
        }

        function setApplicationFilter(filter) {
            document.querySelectorAll('.app-tab').forEach(tab => {
                tab.classList.remove('border-b-2', 'border-bw-green', 'text-bw-green');
                tab.classList.add('border-transparent', 'text-ios-text-secondary');
            });
            
            const activeTab = document.querySelector(`.app-tab[data-filter="${filter}"]`);
            if (activeTab) {
                activeTab.classList.add('border-b-2', 'border-bw-green', 'text-bw-green');
                activeTab.classList.remove('border-transparent', 'text-ios-text-secondary');
            }
            
            loadApplications(filter);
        }

        // ======================
        // AUTHENTICATION
        // ======================
        function showLoginForm() {
            document.getElementById('applicationForm').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function showApplicationForm() {
            // Check if user already has an application
            const lastApplication = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application');
            const applicationStatus = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'application_status');
            
            if (lastApplication && applicationStatus) {
                // Show application status
                showApplicationStatus();
            } else {
                // Show new application form
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('applicationForm').classList.remove('hidden');
                
                const content = `
                    <form onsubmit="submitApplication(event)">
                        <div class="space-y-6">
                            <div>
                                <label class="block text-sm font-medium mb-2">Roblox Username *</label>
                                <input type="text" id="appRoblox" required
                                       class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                       placeholder="Dein Roblox Name">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Vollständiger Name *</label>
                                <input type="text" id="appDisplayName" required
                                       class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                       placeholder="Max Mustermann">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Altersgruppe *</label>
                                <select id="appAgeGroup" required
                                        class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                                    <option value="">Bitte wählen</option>
                                    <option value="under18">Unter 18</option>
                                    <option value="18-25">18-25 Jahre</option>
                                    <option value="26-35">26-35 Jahre</option>
                                    <option value="over35">Über 35 Jahre</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Bevorzugte Division *</label>
                                <select id="appDivision" required
                                        class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                                    <option value="">Bitte wählen</option>
                                    <option value="Heer">Heer</option>
                                    <option value="Marine">Marine</option>
                                    <option value="Luftwaffe">Luftwaffe</option>
                                    <option value="Sanitätsdienst">Sanitätsdienst</option>
                                </select>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-2">Bewerbungstext *</label>
                                <textarea id="appText" rows="6" required
                                          class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                          placeholder="Warum möchtest du der Bundeswehr beitreten? Erzähle etwas über dich..."></textarea>
                            </div>
                            
                            <div id="appError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm"></div>
                            
                            <div class="flex gap-4 pt-4">
                                <button type="submit" class="flex-1 gradient-bw text-white py-3 rounded-ios-sm font-semibold hover:shadow-lg">
                                    <i class="fas fa-paper-plane mr-2"></i>Bewerbung absenden
                                </button>
                                <button type="button" onclick="showLoginForm()" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                                    Abbrechen
                                </button>
                            </div>
                            
                            <p class="text-sm text-ios-text-secondary text-center">
                                <i class="fas fa-info-circle mr-1"></i>
                                Deine Bewerbung wird von der Leitung geprüft. Du wirst per Roblox benachrichtigt.
                            </p>
                        </div>
                    </form>
                `;
                
                document.getElementById('applicationContent').innerHTML = content;
            }
        }

        function showApplicationStatus() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('applicationForm').classList.remove('hidden');
            
            const status = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'application_status');
            const lastApp = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application');
            let application = {};
            
            if (lastApp) {
                try {
                    application = JSON.parse(lastApp);
                } catch (e) {
                    console.error('Error parsing application:', e);
                }
            }
            
            let statusText = '';
            let statusClass = '';
            let statusIcon = '';
            
            switch(status) {
                case 'pending':
                    statusText = 'In Bearbeitung';
                    statusClass = 'status-pending';
                    statusIcon = 'fa-clock';
                    break;
                case 'accepted':
                    statusText = 'Angenommen';
                    statusClass = 'status-accepted';
                    statusIcon = 'fa-check-circle';
                    break;
                case 'rejected':
                    statusText = 'Abgelehnt';
                    statusClass = 'status-rejected';
                    statusIcon = 'fa-times-circle';
                    break;
                default:
                    statusText = 'Unbekannt';
                    statusClass = 'bg-gray-100 text-gray-800';
                    statusIcon = 'fa-question-circle';
            }
            
            const content = `
                <div class="space-y-6">
                    <div class="text-center">
                        <div class="w-20 h-20 mx-auto mb-4 rounded-full ${statusClass} flex items-center justify-center">
                            <i class="fas ${statusIcon} text-3xl"></i>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Bewerbungsstatus</h3>
                        <div class="inline-block px-4 py-2 rounded-full ${statusClass} font-semibold mb-4">
                            ${statusText}
                        </div>
                    </div>
                    
                    ${status === 'pending' ? `
                        <div class="bg-blue-50 border border-blue-200 rounded-ios-sm p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-info-circle text-blue-600 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-blue-800">Deine Bewerbung wird geprüft</p>
                                    <p class="text-sm text-blue-600 mt-1">
                                        Die Leitung prüft aktuell deine Bewerbung. Du wirst benachrichtigt, sobald eine Entscheidung getroffen wurde.
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${status === 'accepted' ? `
                        <div class="bg-green-50 border border-green-200 rounded-ios-sm p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-check-circle text-green-600 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-green-800">Herzlichen Glückwunsch!</p>
                                    <p class="text-sm text-green-600 mt-1">
                                        Deine Bewerbung wurde angenommen. Du wurdest als Schütze in die Bundeswehr aufgenommen.
                                    </p>
                                    <div class="mt-3 p-3 bg-white rounded border border-green-100">
                                        <p class="font-semibold mb-2">Deine Account-Daten:</p>
                                        <p class="text-sm"><span class="font-medium">Username:</span> ${application.username || 'wird zugewiesen'}</p>
                                        <p class="text-sm"><span class="font-medium">Passwort:</span> ${application.password || 'wird zugesendet'}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border border-yellow-200 rounded-ios-sm p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-calendar-alt text-yellow-600 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-yellow-800">Erster Dienst</p>
                                    <p class="text-sm text-yellow-600 mt-1">
                                        Dein erster Dienst beginnt am <strong>${application.startDate || 'wird bekannt gegeben'}</strong> um <strong>${application.startTime || '08:00 Uhr'}</strong>.
                                    </p>
                                    <p class="text-sm text-yellow-600 mt-1">
                                        Treffpunkt: ${application.meetingPoint || 'Kaserne Haupttor'}
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    ${status === 'rejected' ? `
                        <div class="bg-red-50 border border-red-200 rounded-ios-sm p-4">
                            <div class="flex items-start gap-3">
                                <i class="fas fa-times-circle text-red-600 mt-0.5"></i>
                                <div>
                                    <p class="font-medium text-red-800">Bewerbung abgelehnt</p>
                                    <p class="text-sm text-red-600 mt-1">
                                        ${application.rejectionReason || 'Leider entspricht deine Bewerbung nicht unseren aktuellen Anforderungen.'}
                                    </p>
                                    <p class="text-sm text-red-600 mt-2">
                                        Du kannst dich in 30 Tagen erneut bewerben.
                                    </p>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="pt-4 border-t border-ios-border">
                        <button onclick="showLoginForm()" class="w-full bg-bw-green text-white py-3 rounded-ios-sm font-semibold hover:bg-green-800">
                            <i class="fas fa-arrow-left mr-2"></i>Zurück zum Login
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('applicationContent').innerHTML = content;
        }

        function submitApplication(event) {
            event.preventDefault();
            
            const roblox = document.getElementById('appRoblox').value;
            const displayName = document.getElementById('appDisplayName').value;
            const ageGroup = document.getElementById('appAgeGroup').value;
            const division = document.getElementById('appDivision').value;
            const appText = document.getElementById('appText').value;
            
            // Check cooldown
            const lastApplicationTime = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application_time');
            if (lastApplicationTime) {
                const timeSinceLastApp = Date.now() - parseInt(lastApplicationTime);
                if (timeSinceLastApp < APP_CONFIG.applicationCooldown) {
                    const daysLeft = Math.ceil((APP_CONFIG.applicationCooldown - timeSinceLastApp) / (1000 * 60 * 60 * 24));
                    showNotification(`Du kannst erst in ${daysLeft} Tagen erneut eine Bewerbung einreichen.`, 'warning');
                    return;
                }
            }
            
            // Create application
            const application = {
                id: 'app_' + Date.now(),
                roblox_username: roblox,
                display_name: displayName,
                age_group: ageGroup,
                preferred_division: division,
                application_text: appText,
                status: 'pending',
                created_at: new Date().toISOString(),
                application_date: new Date().toLocaleDateString('de-DE')
            };
            
            // Store locally
            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'last_application', JSON.stringify(application));
            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'application_status', 'pending');
            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'last_application_time', Date.now().toString());
            
            // Add to applications list
            applications.push(application);
            
            // Show success
            showNotification('Bewerbung erfolgreich eingereicht!', 'success');
            setTimeout(() => {
                showApplicationStatus();
            }, 1500);
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('loginError', 'Bitte Benutzername und Passwort eingeben');
                return;
            }
            
            showLoading();
            
            try {
                let user = null;
                
                // Check test users first
                if (window.testUsers) {
                    user = window.testUsers.find(u => 
                        u.username === username && u.password === password
                    );
                }
                
                if (user) {
                    // Create session
                    const token = 'test_token_' + Date.now();
                    const tokenExpiry = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days
                    
                    // Store session
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'user', JSON.stringify(user));
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'token', token);
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'token_expiry', tokenExpiry.toString());
                    
                    // Handle login success
                    handleLoginSuccess(user);
                    hideError('loginError');
                    
                    showNotification('Erfolgreich eingeloggt', 'success');
                } else {
                    throw new Error('Falscher Benutzername oder Passwort');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', error.message);
            } finally {
                hideLoading();
            }
        }

        function handleLoginSuccess(user) {
            currentUser = user;
            
            // Update UI
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user display
            updateUserDisplay(user);
            
            // Check permissions
            checkPermissions(user.role);
            
            // Load initial data
            loadDashboard();
            loadMissions();
            loadPersonnel();
            
            // Show dashboard
            showPage('dashboard');
        }

        function logout() {
            if (confirm('Möchtest du dich wirklich ausloggen?')) {
                // Clear session
                localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token');
                localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                
                // Reset UI
                currentUser = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                // Clear forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                hideError('loginError');
                
                showNotification('Erfolgreich ausgeloggt', 'info');
            }
        }

        // ======================
        // USER MANAGEMENT
        // ======================
        function updateUserDisplay(user) {
            // Avatar initials
            const initials = user.display_name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userAvatar').textContent = initials.substring(0, 2);
            document.getElementById('userInitials').textContent = initials.substring(0, 2);
            
            // User info
            document.getElementById('userDisplayName').textContent = user.display_name;
            document.getElementById('userName').textContent = user.display_name;
            document.getElementById('userRank').textContent = user.rank;
            document.getElementById('userRankSmall').textContent = `Rang: ${user.rank}`;
            document.getElementById('userDivision').textContent = `Division: ${user.division}`;
            document.getElementById('userID').textContent = user.soldier_id;
            
            // Stamina
            document.getElementById('staminaValue').textContent = user.stamina;
            document.getElementById('dashboardStamina').textContent = user.stamina;
            
            // Military ID
            document.getElementById('idName').textContent = user.display_name;
            document.getElementById('idRank').textContent = user.rank;
            document.getElementById('idUnit').textContent = user.division;
            document.getElementById('idNumber').textContent = user.soldier_id;
            
            // Service time
            if (user.service_start) {
                const startDate = new Date(user.service_start);
                const now = new Date();
                const months = (now.getFullYear() - startDate.getFullYear()) * 12 + 
                              (now.getMonth() - startDate.getMonth());
                document.getElementById('serviceTime').textContent = `${months} Monat${months !== 1 ? 'e' : ''}`;
                document.getElementById('idStartDate').textContent = new Date(user.service_start).toLocaleDateString('de-DE');
            }
        }

        function checkPermissions(role) {
            const managementSection = document.getElementById('managementSection');
            const createMissionBtn = document.getElementById('createMissionBtn');
            
            if (role === 'admin' || role === 'leader') {
                if (managementSection) managementSection.classList.remove('hidden');
                if (createMissionBtn) createMissionBtn.classList.remove('hidden');
            } else {
                if (managementSection) managementSection.classList.add('hidden');
                if (createMissionBtn) createMissionBtn.classList.add('hidden');
            }
        }

        // ======================
        // DATA LOADING
        // ======================
        function loadDashboard() {
            if (!currentUser) return;
            
            // Update military ID
            updateUserDisplay(currentUser);
            
            // Load upcoming missions
            const upcomingMissions = missions
                .filter(m => m.status === 'upcoming' || m.status === 'active')
                .slice(0, 3);
            
            const container = document.getElementById('upcomingMissions');
            if (container) {
                if (upcomingMissions.length > 0) {
                    let html = '';
                    upcomingMissions.forEach(mission => {
                        const date = new Date(mission.date + 'T' + mission.time);
                        const isParticipant = mission.participants.includes(currentUser.id);
                        
                        html += `
                            <div class="mission-card p-4 rounded-ios-sm bg-white border border-ios-border">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <h3 class="font-bold">${mission.title}</h3>
                                        <p class="text-sm text-ios-text-secondary">${mission.location}</p>
                                    </div>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${
                                        mission.difficulty === 'Hoch' ? 'bg-red-100 text-red-800' :
                                        mission.difficulty === 'Mittel' ? 'bg-yellow-100 text-yellow-800' :
                                        'bg-green-100 text-green-800'
                                    }">
                                        ${mission.difficulty}
                                    </span>
                                </div>
                                
                                <p class="text-sm mb-3 line-clamp-2">${mission.description}</p>
                                
                                <div class="flex justify-between items-center text-sm">
                                    <span class="text-ios-text-secondary">
                                        <i class="far fa-calendar-alt mr-1"></i>
                                        ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                    </span>
                                    
                                    ${isParticipant ? `
                                        <span class="text-green-600 font-medium">
                                            <i class="fas fa-check mr-1"></i>Eingeteilt
                                        </span>
                                    ` : `
                                        <button onclick="joinMission('${mission.id}')" class="text-ios-primary hover:text-ios-primary/80 font-medium">
                                            <i class="fas fa-plus mr-1"></i>Beitreten
                                        </button>
                                    `}
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                            <p>Keine bevorstehenden Einsätze</p>
                        </div>
                    `;
                }
            }
        }

        function loadMissions(filter = 'all') {
            let filteredMissions = missions;
            
            if (filter === 'active') {
                filteredMissions = missions.filter(m => m.status === 'active');
            } else if (filter === 'upcoming') {
                filteredMissions = missions.filter(m => m.status === 'upcoming');
            } else if (filter === 'completed') {
                filteredMissions = missions.filter(m => m.status === 'completed');
            }
            
            const container = document.getElementById('missionsList');
            if (container) {
                if (filteredMissions.length > 0) {
                    let html = '';
                    filteredMissions.forEach(mission => {
                        const date = new Date(mission.date + 'T' + mission.time);
                        const isParticipant = currentUser && mission.participants.includes(currentUser.id);
                        const isCreator = currentUser && mission.created_by === currentUser.id;
                        
                        html += `
                            <div class="mission-card p-5 rounded-ios-sm bg-white border border-ios-border hover:shadow-md transition-shadow">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h3 class="text-xl font-bold mb-1">${mission.title}</h3>
                                        <div class="flex items-center gap-3 text-sm text-ios-text-secondary">
                                            <span><i class="fas fa-map-marker-alt mr-1"></i>${mission.location}</span>
                                            <span>•</span>
                                            <span><i class="fas fa-tag mr-1"></i>${mission.type}</span>
                                            <span>•</span>
                                            <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${
                                                mission.difficulty === 'Hoch' ? 'bg-red-100 text-red-800' :
                                                mission.difficulty === 'Mittel' ? 'bg-yellow-100 text-yellow-800' :
                                                'bg-green-100 text-green-800'
                                            }">
                                                ${mission.difficulty}
                                            </span>
                                        </div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                        mission.status === 'active' ? 'bg-green-100 text-green-800' :
                                        mission.status === 'completed' ? 'bg-gray-100 text-gray-800' :
                                        'bg-blue-100 text-blue-800'
                                    }">
                                        ${mission.status === 'active' ? 'Aktiv' : 
                                          mission.status === 'completed' ? 'Abgeschlossen' : 'Bevorstehend'}
                                    </span>
                                </div>
                                
                                <p class="mb-4">${mission.description}</p>
                                
                                ${mission.plan ? `
                                    <div class="mb-4 p-3 bg-gray-50 rounded-ios-sm">
                                        <div class="font-medium mb-2">Ablauf:</div>
                                        <div class="text-sm whitespace-pre-line">${mission.plan}</div>
                                    </div>
                                ` : ''}
                                
                                <div class="flex justify-between items-center pt-4 border-t border-ios-border">
                                    <div class="text-ios-text-secondary text-sm">
                                        <i class="far fa-calendar-alt mr-1"></i>
                                        ${date.toLocaleDateString('de-DE')} ${date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                                        ${mission.meeting_point ? ` • Treffpunkt: ${mission.meeting_point}` : ''}
                                    </div>
                                    
                                    <div class="flex gap-2">
                                        ${!isParticipant && mission.status !== 'completed' ? `
                                            <button onclick="joinMission('${mission.id}')" class="text-ios-primary hover:text-ios-primary/80 font-medium">
                                                <i class="fas fa-plus mr-1"></i>Beitreten
                                            </button>
                                        ` : isParticipant ? `
                                            <span class="text-green-600 font-medium">
                                                <i class="fas fa-check mr-1"></i>Eingeteilt
                                            </span>
                                        ` : ''}
                                        
                                        ${isCreator || currentUser?.role === 'admin' ? `
                                            <button onclick="editMission('${mission.id}')" class="text-ios-warning hover:text-ios-warning/80">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteMission('${mission.id}')" class="text-red-600 hover:text-red-800">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12 text-ios-text-secondary">
                            <i class="fas fa-crosshairs text-4xl mb-4"></i>
                            <p class="text-lg mb-2">Keine Einsätze gefunden</p>
                            <p class="text-sm">${filter === 'all' ? 'Es sind keine Einsätze verfügbar.' : 
                                               filter === 'active' ? 'Keine aktiven Einsätze.' :
                                               filter === 'upcoming' ? 'Keine bevorstehenden Einsätze.' :
                                               'Keine abgeschlossenen Einsätze.'}</p>
                        </div>
                    `;
                }
            }
        }

        function loadPersonnel() {
            const container = document.getElementById('personnelList');
            if (!container) return;
            
            if (personnel.length > 0) {
                let html = '';
                personnel.forEach(soldier => {
                    const isCurrentUser = currentUser && soldier.id === currentUser.id;
                    const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'leader');
                    
                    html += `
                        <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-ios-sm">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-bw-green to-bw-olive flex items-center justify-center text-white font-bold text-sm">
                                    ${soldier.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                                </div>
                                <div>
                                    <div class="font-medium">
                                        ${soldier.name}
                                        ${isCurrentUser ? ' <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Du</span>' : ''}
                                    </div>
                                    <div class="text-ios-text-secondary text-sm flex items-center gap-2">
                                        <span>${soldier.rank}</span>
                                        <span>•</span>
                                        <span>${soldier.division}</span>
                                        <span>•</span>
                                        <span class="flex items-center gap-1">
                                            <i class="fas fa-fire ${soldier.stamina < 10 ? 'stamina-low' : soldier.stamina < 30 ? 'stamina-medium' : 'stamina-high'}"></i>
                                            ${soldier.stamina} Ausdauer
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            ${isAdmin && !isCurrentUser ? `
                                <div class="relative">
                                    <button onclick="showSoldierActions('${soldier.id}')" class="text-ios-text-secondary hover:text-ios-text p-2">
                                        <i class="fas fa-ellipsis-v"></i>
                                    </button>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });
                container.innerHTML = html;
            } else {
                container.innerHTML = `
                    <div class="text-center py-12 text-ios-text-secondary">
                        <i class="fas fa-users text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Kein Personal gefunden</p>
                        <p class="text-sm">Es sind keine Soldaten registriert.</p>
                    </div>
                `;
            }
        }

        function filterPersonnel() {
            const search = document.getElementById('personnelSearch').value.toLowerCase();
            const division = document.getElementById('divisionFilter').value;
            const rank = document.getElementById('rankFilter').value;
            
            const filtered = personnel.filter(soldier => {
                const matchesSearch = !search || 
                    soldier.name.toLowerCase().includes(search) ||
                    soldier.rank.toLowerCase().includes(search) ||
                    soldier.soldier_id.toLowerCase().includes(search);
                
                const matchesDivision = !division || soldier.division === division;
                const matchesRank = !rank || soldier.rank === rank;
                
                return matchesSearch && matchesDivision && matchesRank;
            });
            
            const container = document.getElementById('personnelList');
            if (container) {
                if (filtered.length > 0) {
                    let html = '';
                    filtered.forEach(soldier => {
                        const isCurrentUser = currentUser && soldier.id === currentUser.id;
                        const isAdmin = currentUser && (currentUser.role === 'admin' || currentUser.role === 'leader');
                        
                        html += `
                            <div class="flex items-center justify-between p-3 hover:bg-gray-50 rounded-ios-sm">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-bw-green to-bw-olive flex items-center justify-center text-white font-bold text-sm">
                                        ${soldier.name.split(' ').map(n => n[0]).join('').substring(0, 2)}
                                    </div>
                                    <div>
                                        <div class="font-medium">
                                            ${soldier.name}
                                            ${isCurrentUser ? ' <span class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Du</span>' : ''}
                                        </div>
                                        <div class="text-ios-text-secondary text-sm flex items-center gap-2">
                                            <span>${soldier.rank}</span>
                                            <span>•</span>
                                            <span>${soldier.division}</span>
                                            <span>•</span>
                                            <span class="flex items-center gap-1">
                                                <i class="fas fa-fire ${soldier.stamina < 10 ? 'stamina-low' : soldier.stamina < 30 ? 'stamina-medium' : 'stamina-high'}"></i>
                                                ${soldier.stamina} Ausdauer
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                ${isAdmin && !isCurrentUser ? `
                                    <div class="relative">
                                        <button onclick="showSoldierActions('${soldier.id}')" class="text-ios-text-secondary hover:text-ios-text p-2">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-search text-2xl mb-3"></i>
                            <p>Keine passenden Soldaten gefunden</p>
                        </div>
                    `;
                }
            }
        }

        function loadManagement() {
            // Update pending applications count
            const pendingCount = applications.filter(app => app.status === 'pending').length;
            document.getElementById('pendingAppsCount2').textContent = pendingCount;
            
            // Load recent activity
            const activityContainer = document.getElementById('managementActivity');
            if (activityContainer) {
                // Simplified activity log
                const activities = [
                    { action: 'Einsatz erstellt', user: 'Oberst Schmidt', time: 'Heute, 14:30' },
                    { action: 'Bewerbung angenommen', user: 'Lisa Müller', time: 'Gestern, 16:45' },
                    { action: 'Ausdauer aktualisiert', user: 'Thomas Weber', time: 'Gestern, 10:20' }
                ];
                
                let html = '';
                activities.forEach(activity => {
                    html += `
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-ios-sm">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <i class="fas fa-history text-gray-600"></i>
                            </div>
                            <div class="flex-1">
                                <p class="font-medium">${activity.action}</p>
                                <p class="text-sm text-ios-text-secondary">${activity.user} • ${activity.time}</p>
                            </div>
                        </div>
                    `;
                });
                activityContainer.innerHTML = html;
            }
        }

        function loadApplications(filter = 'pending') {
            let filteredApps = applications;
            
            if (filter !== 'all') {
                filteredApps = applications.filter(app => app.status === filter);
            }
            
            // Update counts
            const pendingCount = applications.filter(app => app.status === 'pending').length;
            document.getElementById('pendingCount').textContent = pendingCount;
            document.getElementById('pendingAppsBadge').textContent = pendingCount;
            
            if (pendingCount > 0) {
                document.getElementById('pendingAppsBadge').classList.remove('hidden');
            } else {
                document.getElementById('pendingAppsBadge').classList.add('hidden');
            }
            
            const container = document.getElementById('applicationsList');
            if (container) {
                if (filteredApps.length > 0) {
                    let html = '';
                    filteredApps.forEach(app => {
                        html += `
                            <div class="border border-ios-border rounded-ios-sm p-5">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h3 class="font-bold text-lg">${app.display_name}</h3>
                                        <p class="text-ios-text-secondary">
                                            <i class="fab fa-roblox mr-1"></i>${app.roblox_username}
                                            <span class="mx-2">•</span>
                                            <i class="fas fa-calendar-alt mr-1"></i>${app.application_date}
                                            <span class="mx-2">•</span>
                                            ${app.age_group} • ${app.preferred_division}
                                        </p>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                        app.status === 'pending' ? 'status-pending' :
                                        app.status === 'accepted' ? 'status-accepted' :
                                        'status-rejected'
                                    }">
                                        ${app.status === 'pending' ? 'Ausstehend' :
                                          app.status === 'accepted' ? 'Angenommen' : 'Abgelehnt'}
                                    </span>
                                </div>
                                
                                <div class="mb-4">
                                    <p class="text-sm font-medium mb-2">Bewerbungstext:</p>
                                    <div class="bg-gray-50 p-3 rounded-ios-sm whitespace-pre-line">${app.application_text}</div>
                                </div>
                                
                                ${app.status === 'pending' && (currentUser?.role === 'admin' || currentUser?.role === 'leader') ? `
                                    <div class="flex gap-3 pt-4 border-t border-ios-border">
                                        <button onclick="showAcceptApplication('${app.id}')" class="flex-1 bg-green-600 text-white py-2 rounded-ios-sm font-semibold hover:bg-green-700">
                                            <i class="fas fa-check mr-2"></i>Annehmen
                                        </button>
                                        <button onclick="showRejectApplication('${app.id}')" class="flex-1 bg-red-600 text-white py-2 rounded-ios-sm font-semibold hover:bg-red-700">
                                            <i class="fas fa-times mr-2"></i>Ablehnen
                                        </button>
                                        <button onclick="viewApplicationDetails('${app.id}')" class="flex-1 bg-ios-primary text-white py-2 rounded-ios-sm font-semibold hover:bg-ios-primary/90">
                                            <i class="fas fa-eye mr-2"></i>Details
                                        </button>
                                    </div>
                                ` : ''}
                                
                                ${app.status === 'accepted' ? `
                                    <div class="bg-green-50 border border-green-200 rounded-ios-sm p-3 mt-3">
                                        <p class="font-medium text-green-800 mb-1">Aufgenommen als Schütze</p>
                                        <p class="text-sm text-green-600">Account wurde erstellt und Bewerber wurde benachrichtigt.</p>
                                    </div>
                                ` : ''}
                                
                                ${app.status === 'rejected' ? `
                                    <div class="bg-red-50 border border-red-200 rounded-ios-sm p-3 mt-3">
                                        <p class="font-medium text-red-800 mb-1">Abgelehnt</p>
                                        <p class="text-sm text-red-600">Bewerber wurde über die Ablehnung informiert.</p>
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div class="text-center py-12 text-ios-text-secondary">
                            <i class="fas fa-file-alt text-4xl mb-4"></i>
                            <p class="text-lg mb-2">Keine Bewerbungen gefunden</p>
                            <p class="text-sm">${filter === 'pending' ? 'Keine ausstehenden Bewerbungen.' :
                                               filter === 'accepted' ? 'Keine angenommenen Bewerbungen.' :
                                               'Keine abgelehnten Bewerbungen.'}</p>
                        </div>
                    `;
                }
            }
        }

        function loadSettings() {
            if (!currentUser) return;
            
            // Update profile form
            document.getElementById('displayNameInput').value = currentUser.display_name;
            document.getElementById('robloxUsername').value = currentUser.roblox_username || '';
            
            // Load application status
            const statusContainer = document.getElementById('applicationStatus');
            if (statusContainer) {
                const hasApplication = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'application_status');
                
                if (hasApplication) {
                    const status = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'application_status');
                    const lastApp = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application');
                    let application = {};
                    
                    if (lastApp) {
                        try {
                            application = JSON.parse(lastApp);
                        } catch (e) {
                            console.error('Error parsing application:', e);
                        }
                    }
                    
                    let statusText = '';
                    let statusClass = '';
                    
                    switch(status) {
                        case 'pending':
                            statusText = 'In Bearbeitung';
                            statusClass = 'status-pending';
                            break;
                        case 'accepted':
                            statusText = 'Angenommen';
                            statusClass = 'status-accepted';
                            break;
                        case 'rejected':
                            statusText = 'Abgelehnt';
                            statusClass = 'status-rejected';
                            break;
                    }
                    
                    statusContainer.innerHTML = `
                        <div class="p-4 rounded-ios-sm ${statusClass}">
                            <div class="flex items-center gap-3">
                                <i class="fas fa-file-alt text-xl"></i>
                                <div>
                                    <p class="font-medium">Bewerbungsstatus: ${statusText}</p>
                                    <p class="text-sm mt-1">Eingereicht am: ${application.application_date || 'Unbekannt'}</p>
                                    ${status === 'rejected' && application.rejectionReason ? `
                                        <p class="text-sm mt-1">Grund: ${application.rejectionReason}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    statusContainer.innerHTML = `
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-file-alt text-3xl mb-3"></i>
                            <p>Keine aktive Bewerbung</p>
                            <button onclick="showApplicationForm()" class="mt-4 text-ios-primary hover:text-ios-primary/80 font-medium">
                                Neue Bewerbung einreichen →
                            </button>
                        </div>
                    `;
                }
            }
        }

        // ======================
        // MISSION FUNCTIONS
        // ======================
        function showCreateMissionModal() {
            document.getElementById('createMissionModal').classList.remove('hidden');
        }

        function hideCreateMissionModal() {
            document.getElementById('createMissionModal').classList.add('hidden');
            document.getElementById('missionError').classList.add('hidden');
        }

        function createMission() {
            const title = document.getElementById('missionTitle').value;
            const description = document.getElementById('missionDescription').value;
            const location = document.getElementById('missionLocation').value;
            const meetingPoint = document.getElementById('missionMeetingPoint').value;
            const type = document.getElementById('missionType').value;
            const difficulty = document.getElementById('missionDifficulty').value;
            const date = document.getElementById('missionDate').value;
            const time = document.getElementById('missionTime').value;
            const plan = document.getElementById('missionPlan').value;
            
            if (!title || !description || !location || !date || !time) {
                document.getElementById('missionError').classList.remove('hidden');
                return;
            }
            
            const newMission = {
                id: 'mission_' + Date.now(),
                title: title,
                description: description,
                location: location,
                meeting_point: meetingPoint,
                type: type,
                difficulty: difficulty,
                date: date,
                time: time,
                plan: plan,
                status: 'upcoming',
                created_by: currentUser.id,
                participants: [],
                created_at: new Date().toISOString()
            };
            
            missions.push(newMission);
            hideCreateMissionModal();
            
            // Reset form
            document.getElementById('missionTitle').value = '';
            document.getElementById('missionDescription').value = '';
            document.getElementById('missionLocation').value = '';
            document.getElementById('missionMeetingPoint').value = '';
            document.getElementById('missionPlan').value = '';
            
            showNotification('Einsatz erfolgreich erstellt', 'success');
            loadMissions();
            loadDashboard();
        }

        function joinMission(missionId) {
            const mission = missions.find(m => m.id === missionId);
            if (!mission) return;
            
            if (!mission.participants.includes(currentUser.id)) {
                mission.participants.push(currentUser.id);
                showNotification(`Du bist dem Einsatz "${mission.title}" beigetreten`, 'success');
                loadMissions();
                loadDashboard();
            } else {
                showNotification('Du bist bereits diesem Einsatz zugeteilt', 'info');
            }
        }

        // ======================
        // APPLICATION MANAGEMENT
        // ======================
        function showAcceptApplication(appId) {
            const app = applications.find(a => a.id === appId);
            if (!app) return;
            
            document.getElementById('acceptAppInfo').innerHTML = `
                <div class="bg-gray-50 p-3 rounded-ios-sm mb-4">
                    <p class="font-medium">${app.display_name}</p>
                    <p class="text-sm text-ios-text-secondary">Roblox: ${app.roblox_username}</p>
                    <p class="text-sm text-ios-text-secondary">Beworben für: ${app.preferred_division}</p>
                </div>
            `;
            
            document.getElementById('acceptApplicationModal').classList.remove('hidden');
            window.currentAcceptAppId = appId;
        }

        function hideAcceptApplicationModal() {
            document.getElementById('acceptApplicationModal').classList.add('hidden');
            document.getElementById('acceptError').classList.add('hidden');
            window.currentAcceptAppId = null;
        }

        function acceptApplicationConfirm() {
            const username = document.getElementById('acceptUsername').value;
            const password = document.getElementById('acceptPassword').value;
            const rank = document.getElementById('acceptRank').value;
            const message = document.getElementById('acceptMessage').value;
            
            if (!username || !password) {
                document.getElementById('acceptError').classList.remove('hidden');
                return;
            }
            
            const appId = window.currentAcceptAppId;
            const app = applications.find(a => a.id === appId);
            
            if (app) {
                // Update application status
                app.status = 'accepted';
                
                // Create new user account
                const newUserId = 'user_' + Date.now();
                const newSoldierId = 'BW-' + (1000 + personnel.length).toString().padStart(4, '0');
                
                const newUser = {
                    id: newUserId,
                    username: username,
                    password: password,
                    display_name: app.display_name,
                    rank: rank,
                    division: app.preferred_division,
                    role: 'soldier',
                    stamina: 0,
                    soldier_id: newSoldierId,
                    service_start: new Date().toISOString().split('T')[0],
                    roblox_username: app.roblox_username
                };
                
                // Add to personnel
                personnel.push({
                    id: newUserId,
                    name: app.display_name,
                    rank: rank,
                    division: app.preferred_division,
                    stamina: 0,
                    soldier_id: newSoldierId,
                    role: 'soldier',
                    username: username
                });
                
                // Also add to test users for login
                if (window.testUsers) {
                    window.testUsers.push(newUser);
                }
                
                // Update local storage if this is the current user's application
                const lastApp = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application');
                if (lastApp) {
                    try {
                        const savedApp = JSON.parse(lastApp);
                        if (savedApp.roblox_username === app.roblox_username) {
                            savedApp.username = username;
                            savedApp.password = password;
                            savedApp.startDate = new Date(Date.now() + 86400000).toLocaleDateString('de-DE');
                            savedApp.startTime = '08:00';
                            savedApp.meetingPoint = 'Kaserne Haupttor';
                            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'last_application', JSON.stringify(savedApp));
                            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'application_status', 'accepted');
                        }
                    } catch (e) {
                        console.error('Error updating local storage:', e);
                    }
                }
                
                hideAcceptApplicationModal();
                showNotification('Bewerbung angenommen und Account erstellt', 'success');
                loadApplications();
                loadManagement();
                
                // Show credentials
                setTimeout(() => {
                    alert(`Account erstellt für ${app.display_name}:\n\nUsername: ${username}\nPasswort: ${password}\n\nDiese Daten bitte an den Bewerber weitergeben.`);
                }, 500);
            }
        }

        function showRejectApplication(appId) {
            const app = applications.find(a => a.id === appId);
            if (!app) return;
            
            document.getElementById('rejectAppInfo').innerHTML = `
                <div class="bg-gray-50 p-3 rounded-ios-sm mb-4">
                    <p class="font-medium">${app.display_name}</p>
                    <p class="text-sm text-ios-text-secondary">Roblox: ${app.roblox_username}</p>
                </div>
            `;
            
            document.getElementById('rejectApplicationModal').classList.remove('hidden');
            window.currentRejectAppId = appId;
        }

        function hideRejectApplicationModal() {
            document.getElementById('rejectApplicationModal').classList.add('hidden');
            document.getElementById('rejectError').classList.add('hidden');
            window.currentRejectAppId = null;
        }

        function rejectApplicationConfirm() {
            const reason = document.getElementById('rejectReason').value;
            
            if (!reason) {
                document.getElementById('rejectError').classList.remove('hidden');
                return;
            }
            
            const appId = window.currentRejectAppId;
            const app = applications.find(a => a.id === appId);
            
            if (app) {
                // Update application status
                app.status = 'rejected';
                app.rejectionReason = reason;
                
                // Update local storage if this is the current user's application
                const lastApp = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_application');
                if (lastApp) {
                    try {
                        const savedApp = JSON.parse(lastApp);
                        if (savedApp.roblox_username === app.roblox_username) {
                            savedApp.rejectionReason = reason;
                            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'last_application', JSON.stringify(savedApp));
                            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'application_status', 'rejected');
                        }
                    } catch (e) {
                        console.error('Error updating local storage:', e);
                    }
                }
                
                hideRejectApplicationModal();
                showNotification('Bewerbung abgelehnt', 'info');
                loadApplications();
                loadManagement();
            }
        }

        // ======================
        // SOLDIER ACTIONS
        // ======================
        function showSoldierActions(soldierId) {
            const soldier = personnel.find(p => p.id === soldierId);
            if (!soldier) return;
            
            document.getElementById('soldierActionsTitle').textContent = `Aktionen für ${soldier.name}`;
            
            const actionsHtml = `
                <button onclick="promoteSoldier('${soldierId}')" class="w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                    <i class="fas fa-star text-yellow-500"></i>
                    <span>Befördern</span>
                </button>
                
                <button onclick="addStamina('${soldierId}', 1)" class="w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                    <i class="fas fa-plus text-green-500"></i>
                    <span>+1 Ausdauer (Pushups)</span>
                </button>
                
                <button onclick="addStamina('${soldierId}', 2)" class="w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                    <i class="fas fa-plus text-green-500"></i>
                    <span>+2 Ausdauer (Klimmzüge)</span>
                </button>
                
                <button onclick="addStamina('${soldierId}', 3)" class="w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                    <i class="fas fa-plus text-green-500"></i>
                    <span>+3 Ausdauer (5km Lauf)</span>
                </button>
                
                <button onclick="editSoldier('${soldierId}')" class="w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                    <i class="fas fa-edit text-blue-500"></i>
                    <span>Bearbeiten</span>
                </button>
            `;
            
            document.getElementById('soldierActionsContent').innerHTML = actionsHtml;
            document.getElementById('soldierActionsModal').classList.remove('hidden');
            window.currentSoldierId = soldierId;
        }

        function hideSoldierActionsModal() {
            document.getElementById('soldierActionsModal').classList.add('hidden');
            window.currentSoldierId = null;
        }

        function promoteSoldier(soldierId) {
            const soldier = personnel.find(p => p.id === soldierId);
            if (!soldier) return;
            
            const currentRankIndex = APP_CONFIG.ranks.indexOf(soldier.rank);
            if (currentRankIndex === -1 || currentRankIndex >= APP_CONFIG.ranks.length - 1) {
                showNotification('Beförderung nicht möglich', 'warning');
                return;
            }
            
            const newRank = APP_CONFIG.ranks[currentRankIndex + 1];
            const confirmMsg = `${soldier.name} von ${soldier.rank} zu ${newRank} befördern?`;
            
            if (confirm(confirmMsg)) {
                soldier.rank = newRank;
                
                // Also update in test users
                if (window.testUsers) {
                    const testUser = window.testUsers.find(u => u.id === soldierId);
                    if (testUser) {
                        testUser.rank = newRank;
                    }
                }
                
                // Update current user if it's them
                if (currentUser && currentUser.id === soldierId) {
                    currentUser.rank = newRank;
                    updateUserDisplay(currentUser);
                }
                
                hideSoldierActionsModal();
                showNotification(`${soldier.name} zu ${newRank} befördert`, 'success');
                loadPersonnel();
            }
        }

        function addStamina(soldierId, amount) {
            const soldier = personnel.find(p => p.id === soldierId);
            if (!soldier) return;
            
            const exerciseNames = {
                1: 'Pushups (Liegestütze)',
                2: 'Klimmzüge',
                3: '5km Lauf'
            };
            
            const exerciseName = exerciseNames[amount] || 'Training';
            
            if (confirm(`${soldier.name} ${amount} Ausdauer für ${exerciseName} gutschreiben?`)) {
                soldier.stamina += amount;
                
                // Also update in test users
                if (window.testUsers) {
                    const testUser = window.testUsers.find(u => u.id === soldierId);
                    if (testUser) {
                        testUser.stamina = soldier.stamina;
                    }
                }
                
                // Update current user if it's them
                if (currentUser && currentUser.id === soldierId) {
                    currentUser.stamina = soldier.stamina;
                    updateUserDisplay(currentUser);
                }
                
                hideSoldierActionsModal();
                showNotification(`${soldier.name}: +${amount} Ausdauer für ${exerciseName}`, 'success');
                loadPersonnel();
            }
        }

        // ======================
        // MILITARY ID
        // ======================
        function showMilitaryID() {
            if (!currentUser) return;
            
            document.getElementById('modalName').textContent = currentUser.display_name;
            document.getElementById('modalRank').textContent = currentUser.rank;
            document.getElementById('modalUnit').textContent = currentUser.division;
            document.getElementById('modalPersonnelID').textContent = currentUser.soldier_id.split('-')[1] || '0000';
            document.getElementById('modalPersonnelNumber').textContent = currentUser.soldier_id;
            document.getElementById('modalIDNumber').textContent = currentUser.soldier_id;
            
            if (currentUser.service_start) {
                const startDate = new Date(currentUser.service_start);
                document.getElementById('modalStartDate').textContent = startDate.toLocaleDateString('de-DE');
                
                // Valid for 1 year from start
                const validUntil = new Date(startDate);
                validUntil.setFullYear(validUntil.getFullYear() + 1);
                document.getElementById('modalValidUntil').textContent = validUntil.toLocaleDateString('de-DE');
            }
            
            document.getElementById('militaryIDModal').classList.remove('hidden');
        }

        function hideMilitaryID() {
            document.getElementById('militaryIDModal').classList.add('hidden');
        }

        // ======================
        // USER MANAGEMENT
        // ======================
        function showCreateUserModal() {
            document.getElementById('createUserModal').classList.remove('hidden');
        }

        function hideCreateUserModal() {
            document.getElementById('createUserModal').classList.add('hidden');
            document.getElementById('createUserError').classList.add('hidden');
        }

        function createUser() {
            const name = document.getElementById('createUserName').value;
            const username = document.getElementById('createUserUsername').value;
            const password = document.getElementById('createUserPassword').value;
            const rank = document.getElementById('createUserRank').value;
            const division = document.getElementById('createUserDivision').value;
            const role = document.getElementById('createUserRole').value;
            
            if (!name || !username || !password || !rank || !division) {
                document.getElementById('createUserError').classList.remove('hidden');
                return;
            }
            
            const newUserId = 'user_' + Date.now();
            const newSoldierId = 'BW-' + (1000 + personnel.length).toString().padStart(4, '0');
            
            const newUser = {
                id: newUserId,
                username: username,
                password: password,
                display_name: name,
                rank: rank,
                division: division,
                role: role,
                stamina: 0,
                soldier_id: newSoldierId,
                service_start: new Date().toISOString().split('T')[0]
            };
            
            // Add to personnel
            personnel.push({
                id: newUserId,
                name: name,
                rank: rank,
                division: division,
                stamina: 0,
                soldier_id: newSoldierId,
                role: role,
                username: username
            });
            
            // Also add to test users for login
            if (window.testUsers) {
                window.testUsers.push(newUser);
            }
            
            hideCreateUserModal();
            showNotification(`Account für ${name} erstellt`, 'success');
            loadPersonnel();
            
            // Show credentials
            setTimeout(() => {
                alert(`Account erstellt:\n\nName: ${name}\nUsername: ${username}\nPasswort: ${password}\nRang: ${rank}\nDivision: ${division}\nRolle: ${role}`);
            }, 500);
        }

        function updateProfile() {
            if (!currentUser) return;
            
            const displayName = document.getElementById('displayNameInput').value;
            const robloxUsername = document.getElementById('robloxUsername').value;
            
            if (!displayName) {
                showNotification('Bitte einen Namen eingeben', 'warning');
                return;
            }
            
            // Update current user
            currentUser.display_name = displayName;
            currentUser.roblox_username = robloxUsername;
            
            // Update in personnel
            const personnelIndex = personnel.findIndex(p => p.id === currentUser.id);
            if (personnelIndex !== -1) {
                personnel[personnelIndex].name = displayName;
            }
            
            // Update in test users
            if (window.testUsers) {
                const testUserIndex = window.testUsers.findIndex(u => u.id === currentUser.id);
                if (testUserIndex !== -1) {
                    window.testUsers[testUserIndex].display_name = displayName;
                    window.testUsers[testUserIndex].roblox_username = robloxUsername;
                }
            }
            
            // Update local storage
            localStorage.setItem(APP_CONFIG.localStoragePrefix + 'user', JSON.stringify(currentUser));
            
            // Update UI
            updateUserDisplay(currentUser);
            
            showNotification('Profil aktualisiert', 'success');
        }

        // ======================
        // UTILITY FUNCTIONS
        // ======================
        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                element.querySelector('span').textContent = message;
                element.classList.remove('hidden');
            }
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const id = 'notif_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const colors = {
                success: 'green',
                error: 'red',
                warning: 'yellow',
                info: 'blue'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `ios-card rounded-ios-sm p-4 slide-in border-l-4 border-${colors[type]}-500`;
            
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fas fa-${icons[type]} text-${colors[type]}-500 mt-0.5"></i>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${id}').remove()" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const notif = document.getElementById(id);
                if (notif) {
                    notif.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => notif.remove(), 300);
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ======================
        // DATABASE SETUP
        // ======================
        // This SQL should be run in Supabase SQL Editor
        const databaseSetupSQL = `
        -- Create tables for Bundeswehr RP System
        
        -- Users table
        CREATE TABLE IF NOT EXISTS users (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            username VARCHAR(50) UNIQUE NOT NULL,
            password_hash TEXT NOT NULL,
            display_name VARCHAR(100) NOT NULL,
            rank VARCHAR(50) DEFAULT 'Schütze',
            division VARCHAR(50) DEFAULT 'Heer',
            stamina INTEGER DEFAULT 0,
            role VARCHAR(20) DEFAULT 'soldier' CHECK (role IN ('soldier', 'leader', 'admin')),
            soldier_id VARCHAR(20) UNIQUE NOT NULL,
            roblox_username VARCHAR(100),
            service_start DATE DEFAULT CURRENT_DATE,
            last_login TIMESTAMP,
            created_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Applications table
        CREATE TABLE IF NOT EXISTS applications (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            roblox_username VARCHAR(100) NOT NULL,
            display_name VARCHAR(100) NOT NULL,
            application_text TEXT NOT NULL,
            age_group VARCHAR(20),
            preferred_division VARCHAR(50),
            status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'rejected')),
            rejection_reason TEXT,
            created_at TIMESTAMP DEFAULT NOW(),
            reviewed_by UUID REFERENCES users(id),
            reviewed_at TIMESTAMP
        );
        
        -- Missions table
        CREATE TABLE IF NOT EXISTS missions (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            title VARCHAR(200) NOT NULL,
            description TEXT NOT NULL,
            location VARCHAR(200),
            meeting_point VARCHAR(200),
            mission_type VARCHAR(50),
            difficulty VARCHAR(20) CHECK (difficulty IN ('Niedrig', 'Mittel', 'Hoch')),
            mission_date DATE NOT NULL,
            mission_time TIME NOT NULL,
            plan TEXT,
            status VARCHAR(20) DEFAULT 'upcoming' CHECK (status IN ('upcoming', 'active', 'completed', 'cancelled')),
            created_by UUID REFERENCES users(id) NOT NULL,
            created_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Mission participants
        CREATE TABLE IF NOT EXISTS mission_participants (
            mission_id UUID REFERENCES missions(id) ON DELETE CASCADE,
            user_id UUID REFERENCES users(id) ON DELETE CASCADE,
            joined_at TIMESTAMP DEFAULT NOW(),
            PRIMARY KEY (mission_id, user_id)
        );
        
        -- Activity log
        CREATE TABLE IF NOT EXISTS activity_log (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            user_id UUID REFERENCES users(id),
            action_type VARCHAR(50) NOT NULL,
            description TEXT NOT NULL,
            details JSONB,
            created_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Create test admin account (password: bundeswehr123)
        INSERT INTO users (username, password_hash, display_name, rank, division, role, soldier_id) 
        VALUES (
            'admin_test',
            '$2b$10$YourHashedPasswordHere', -- Replace with actual bcrypt hash
            'Oberst Markus Schmidt',
            'Oberst',
            'Heer',
            'admin',
            'BW-0001'
        ) ON CONFLICT (username) DO NOTHING;
        `;

        // Make SQL available globally for copy-paste
        window.databaseSetupSQL = databaseSetupSQL;
        console.log('Database setup SQL available at window.databaseSetupSQL');
    </script>
</body>
</html>
