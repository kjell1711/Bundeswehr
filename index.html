<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bundeswehr RP</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com/3.4.0"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        ios: {
                            bg: '#f5f5f7',
                            card: '#ffffff',
                            primary: '#007aff',
                            secondary: '#5856d6',
                            success: '#34c759',
                            warning: '#ff9500',
                            danger: '#ff3b30',
                            text: '#1d1d1f',
                            'text-secondary': '#8e8e93',
                            border: '#d1d1d6'
                        },
                        bw: {
                            green: '#006400',
                            olive: '#556b2f',
                            gray: '#4a4a4a',
                            dark: '#2c2c2e'
                        }
                    },
                    borderRadius: {
                        'ios': '12px',
                        'ios-sm': '8px',
                        'ios-lg': '16px',
                        'ios-xl': '20px'
                    },
                    boxShadow: {
                        'ios': '0 4px 20px rgba(0, 0, 0, 0.08)',
                        'ios-lg': '0 10px 40px rgba(0, 0, 0, 0.1)',
                        'ios-xl': '0 20px 60px rgba(0, 0, 0, 0.12)'
                    },
                    backdropBlur: {
                        'ios': '20px'
                    }
                }
            }
        }
    </script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* Modern iOS Design */
        * {
            transition: background-color 0.2s, transform 0.2s, border-color 0.2s;
        }
        
        body {
            background-color: #f5f5f7;
        }
        
        .ios-card {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }
        
        .bw-card {
            background: white;
            border: 1px solid #e5e5e7;
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #006400, #008000);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .gradient-primary {
            background: linear-gradient(135deg, #007aff, #0056cc);
        }
        
        .gradient-success {
            background: linear-gradient(135deg, #34c759, #2d9950);
        }
        
        .gradient-bw {
            background: linear-gradient(135deg, #006400, #004d00);
        }
        
        .soldier-id-badge {
            background: linear-gradient(135deg, #1d1d1f, #2c2c2e);
            color: white;
        }
        
        .stamina-badge {
            background: linear-gradient(135deg, #ff9500, #e68500);
            color: white;
        }
        
        .rank-badge {
            background: linear-gradient(135deg, #5856d6, #4a48b8);
            color: white;
        }
        
        /* Smooth animations */
        @keyframes slideIn {
            from { transform: translateY(-10px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .slide-in {
            animation: slideIn 0.3s ease-out;
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Hide scrollbar but keep functionality */
        .hide-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .hide-scrollbar::-webkit-scrollbar {
            display: none;
        }
        
        /* Custom scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Loading spinner */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007aff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Collapsible sidebar */
        .sidebar-collapsed {
            width: 70px;
        }
        
        .sidebar-expanded {
            width: 250px;
        }
        
        .main-expanded {
            margin-left: 250px;
        }
        
        .main-collapsed {
            margin-left: 70px;
        }
        
        @media (max-width: 768px) {
            .sidebar-expanded, .sidebar-collapsed {
                width: 100%;
                position: fixed;
                z-index: 1000;
                height: auto;
                bottom: 0;
                top: auto;
                border-right: none;
                border-top: 1px solid #e5e5e7;
            }
            
            .main-expanded, .main-collapsed {
                margin-left: 0;
                margin-bottom: 70px;
            }
        }
        
        /* Military ID Card */
        .military-id {
            background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
            color: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .military-id::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(0, 100, 0, 0.1) 0%, transparent 70%);
        }
        
        .military-id-header {
            background: rgba(0, 100, 0, 0.2);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .id-number {
            font-family: 'Courier New', monospace;
            letter-spacing: 2px;
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 8px;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Mission Card */
        .mission-card {
            border-left: 4px solid #007aff;
        }
        
        .mission-active {
            border-left-color: #34c759;
        }
        
        .mission-completed {
            border-left-color: #8e8e93;
        }
        
        /* Application Status */
        .status-pending {
            background: rgba(255, 149, 0, 0.1);
            color: #ff9500;
            border: 1px solid rgba(255, 149, 0, 0.2);
        }
        
        .status-accepted {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            border: 1px solid rgba(52, 199, 89, 0.2);
        }
        
        .status-rejected {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            border: 1px solid rgba(255, 59, 48, 0.2);
        }
        
        /* Stamina Indicator */
        .stamina-low { color: #ff3b30; }
        .stamina-medium { color: #ff9500; }
        .stamina-high { color: #34c759; }
        
        .stamina-bar-low { background: #ff3b30; }
        .stamina-bar-medium { background: #ff9500; }
        .stamina-bar-high { background: #34c759; }
        
        /* Visitor ID Card */
        .visitor-id {
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            border-radius: 12px;
            position: relative;
            overflow: hidden;
        }
        
        .visitor-id-header {
            background: rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .visitor-badge {
            background: linear-gradient(135deg, #ff9500, #ff5e3a);
            color: white;
        }
    </style>
</head>
<body class="bg-ios-bg text-ios-text font-sans min-h-screen">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center p-4 gradient-bg">
        <div class="ios-card rounded-ios-xl shadow-ios-xl p-6 sm:p-8 w-full max-w-md">
            <!-- Logo -->
            <div class="w-24 h-24 sm:w-28 sm:h-28 mx-auto mb-6 rounded-2xl gradient-bw flex items-center justify-center shadow-lg">
                <i class="fas fa-shield-alt text-white text-4xl"></i>
            </div>
            
            <h1 class="text-3xl font-bold text-center mb-2 gradient-text">Bundeswehr RP</h1>
            <p class="text-ios-text-secondary text-center mb-8">Militärisches Rollenspiel Management</p>
            
            <!-- Login Form -->
            <div class="space-y-4" id="loginForm">
                <div>
                    <label class="block text-sm font-medium mb-2 text-bw-gray">Benutzername</label>
                    <input type="text" id="loginUsername" 
                           class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                           placeholder="Benutzername">
                </div>
                
                <div>
                    <label class="block text-sm font-medium mb-2 text-bw-gray">Passwort</label>
                    <input type="password" id="loginPassword" 
                           class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                           placeholder="••••••••">
                </div>
                
                <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm text-sm">
                    <i class="fas fa-exclamation-circle mr-2"></i>
                    <span id="loginErrorText">Falscher Benutzername oder Passwort</span>
                </div>
                
                <button id="loginButton" class="w-full gradient-bw text-white py-3 rounded-ios-sm font-semibold text-lg hover:shadow-lg transition-shadow">
                    <i class="fas fa-sign-in-alt mr-2"></i>Einloggen
                </button>
            </div>
            
            <!-- Application Button -->
            <div class="mt-6 pt-6 border-t border-ios-border">
                <button id="applicationButton" class="w-full bg-white border-2 border-bw-green text-bw-green py-3 rounded-ios-sm font-semibold text-lg hover:bg-bw-green hover:text-white transition-colors mb-3">
                    <i class="fas fa-file-alt mr-2"></i>Bewerben
                </button>
                
                <!-- NEU: Besucherausweis Button -->
                <button id="visitorButton" class="w-full bg-white border-2 border-blue-600 text-blue-600 py-3 rounded-ios-sm font-semibold text-lg hover:bg-blue-600 hover:text-white transition-colors">
                    <i class="fas fa-id-card mr-2"></i>Besucherausweis beantragen
                </button>
            </div>
            
            <div class="mt-8 pt-6 border-t border-ios-border text-center text-ios-text-secondary text-sm">
                <p><i class="fas fa-shield-alt mr-2"></i>Offizielles Bundeswehr RP System</p>
            </div>
        </div>
    </div>

    <!-- Application Form (Hidden initially) -->
    <div id="applicationForm" class="hidden min-h-screen flex items-center justify-center p-4 bg-gray-50">
        <div class="ios-card rounded-ios-xl shadow-ios-xl p-6 w-full max-w-2xl">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold gradient-text">Bewerbung</h2>
                    <p class="text-ios-text-secondary">Bewerben Sie sich für die Bundeswehr</p>
                </div>
                <button id="backToLoginButton" class="text-ios-text-secondary hover:text-ios-text">
                    <i class="fas fa-arrow-left"></i> Zurück
                </button>
            </div>
            
            <div id="applicationContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Visitor Form (Hidden initially) -->
    <div id="visitorForm" class="hidden min-h-screen flex items-center justify-center p-4 bg-gray-50">
        <div class="ios-card rounded-ios-xl shadow-ios-xl p-6 w-full max-w-2xl">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold gradient-text">Besucherausweis</h2>
                    <p class="text-ios-text-secondary">Besucherausweis für die Kaserne beantragen</p>
                </div>
                <button id="backToLoginButton2" class="text-ios-text-secondary hover:text-ios-text">
                    <i class="fas fa-arrow-left"></i> Zurück
                </button>
            </div>
            
            <div id="visitorContent">
                <!-- Content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="hidden">
        <!-- Top Navigation -->
        <nav class="bg-white border-b border-ios-border px-4 sm:px-6 py-3 flex items-center justify-between sticky top-0 z-40">
            <!-- Left: Hamburger menu and ID button -->
            <div class="flex items-center gap-3">
                <button id="sidebarToggle" class="text-ios-text-secondary hover:text-ios-text p-2">
                    <i class="fas fa-bars text-lg"></i>
                </button>
                
                <button id="showIDButton" class="flex items-center gap-2 text-ios-text hover:text-ios-primary">
                    <i class="fas fa-id-card"></i>
                    <span class="hidden sm:inline text-sm font-medium">Ausweis</span>
                </button>
            </div>
            
            <!-- Center: Time -->
            <div class="flex items-center gap-3">
                <div id="currentTime" class="font-mono font-bold text-lg">00:00</div>
                <div class="hidden sm:block text-ios-text-secondary text-sm">
                    <span id="currentDate">01.01.2024</span>
                </div>
            </div>
            
            <!-- Right: User info and logout -->
            <div class="flex items-center gap-3">
                <div id="userStaminaBadge" class="hidden sm:flex items-center gap-2 bg-orange-50 px-3 py-1.5 rounded-full border border-orange-100">
                    <i class="fas fa-fire text-orange-500"></i>
                    <span class="font-semibold text-sm text-orange-700">
                        Ausdauer: <span id="staminaValue">0</span>
                    </span>
                </div>
                
                <div class="hidden sm:flex items-center gap-2">
                    <div class="w-8 h-8 rounded-full bg-bw-green flex items-center justify-center text-white font-bold text-sm">
                        <span id="userInitials">BW</span>
                    </div>
                    <div>
                        <div id="userName" class="font-medium text-sm">Lade...</div>
                        <div id="userRankSmall" class="text-xs text-ios-text-secondary">Rang: -</div>
                    </div>
                </div>
                
                <button id="logoutButton" class="text-red-500 hover:text-red-700 p-2" title="Ausloggen">
                    <i class="fas fa-sign-out-alt"></i>
                </button>
            </div>
        </nav>

        <!-- Sidebar -->
        <div id="sidebar" class="sidebar-expanded bg-white border-r border-ios-border h-[calc(100vh-64px)] overflow-y-auto hide-scrollbar fixed left-0 top-16 transition-all duration-300">
            <!-- User Profile -->
            <div class="p-4 border-b border-ios-border">
                <div class="flex items-center gap-3 mb-3">
                    <div id="userAvatar" class="w-12 h-12 rounded-full bg-gradient-to-br from-bw-green to-bw-olive flex items-center justify-center text-white font-bold">
                        BW
                    </div>
                    <div class="flex-1 min-w-0">
                        <div id="userDisplayName" class="font-bold truncate">Lade...</div>
                        <div id="userDivision" class="text-sm text-ios-text-secondary truncate">Division: -</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <div class="text-center p-2 bg-gray-50 rounded-ios-sm">
                        <div class="text-xs text-ios-text-secondary">Rang</div>
                        <div id="userRank" class="font-semibold">-</div>
                    </div>
                    <div class="text-center p-2 bg-gray-50 rounded-ios-sm">
                        <div class="text-xs text-ios-text-secondary">ID</div>
                        <div id="userID" class="font-mono text-sm">#0000</div>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="p-2">
                <div class="space-y-1">
                    <button data-page="dashboard" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-home w-5 text-center"></i>
                        <span>Dashboard</span>
                    </button>
                    
                    <button data-page="missions" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-crosshairs w-5 text-center"></i>
                        <span>Einsätze</span>
                    </button>
                    
                    <button data-page="personnel" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-users w-5 text-center"></i>
                        <span>Personal</span>
                    </button>
                    
                    <!-- NEU: Besucher Seite für alle sichtbar -->
                    <button data-page="visitors" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-user-tag w-5 text-center"></i>
                        <span>Besucher</span>
                    </button>
                    
                    <div id="managementSection" class="hidden">
                        <div class="text-xs font-semibold text-ios-text-secondary uppercase tracking-wider px-4 py-2">Leitung</div>
                        
                        <button data-page="management" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                            <i class="fas fa-tasks w-5 text-center"></i>
                            <span>Management</span>
                        </button>
                        
                        <button data-page="applications" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                            <i class="fas fa-file-alt w-5 text-center"></i>
                            <span>Bewerbungen</span>
                            <span id="pendingAppsBadge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                        
                        <!-- NEU: Besucher Anfragen für Leitung -->
                        <button data-page="visitorRequests" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                            <i class="fas fa-id-card w-5 text-center"></i>
                            <span>Besucher-Anfragen</span>
                            <span id="pendingVisitorBadge" class="ml-auto bg-red-500 text-white text-xs px-2 py-0.5 rounded-full hidden">0</span>
                        </button>
                    </div>
                    
                    <button data-page="settings" class="nav-item w-full text-left px-4 py-3 rounded-ios-sm flex items-center gap-3 hover:bg-gray-50 text-ios-text">
                        <i class="fas fa-cog w-5 text-center"></i>
                        <span>Einstellungen</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div id="mainContent" class="main-expanded p-4 sm:p-6 transition-all duration-300 min-h-[calc(100vh-64px)]">
            <!-- Dashboard Page -->
            <div id="dashboardPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Dashboard</h1>
                    <p class="text-ios-text-secondary">Willkommen bei der Bundeswehr</p>
                </div>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <!-- Military ID Card -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-lg font-bold">Truppenausweis</h2>
                            <button id="showIDButton2" class="text-ios-primary hover:text-ios-primary/80">
                                <i class="fas fa-expand"></i>
                            </button>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Name:</span>
                                <span id="idName" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstgrad:</span>
                                <span id="idRank" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Einheit:</span>
                                <span id="idUnit" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Personalnummer:</span>
                                <span id="idNumber" class="font-mono text-sm">#0000</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstbeginn:</span>
                                <span id="idStartDate" class="font-semibold">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stamina -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <h2 class="text-lg font-bold mb-4">Ausdauer</h2>
                        <div class="text-center mb-4">
                            <div class="text-4xl font-bold mb-2">
                                <span id="dashboardStamina">0</span>
                                <span class="text-2xl text-ios-text-secondary">/∞</span>
                            </div>
                            <div class="text-ios-text-secondary text-sm">
                                Trainingspunkte
                            </div>
                        </div>
                        <div class="text-sm text-ios-text-secondary">
                            <i class="fas fa-info-circle mr-1"></i>
                            Erhalten durch Training mit Ausbildern
                        </div>
                    </div>
                    
                    <!-- Service Info -->
                    <div class="ios-card rounded-ios-lg p-5">
                        <h2 class="text-lg font-bold mb-4">Dienstinformationen</h2>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Dienstzeit:</span>
                                <span id="serviceTime" class="font-semibold">-</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Status:</span>
                                <span id="serviceStatus" class="px-2 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-800">Aktiv</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-ios-text-secondary">Letzte Beförderung:</span>
                                <span id="lastPromotion" class="font-semibold">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Upcoming Missions -->
                <div class="ios-card rounded-ios-lg p-5 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Bevorstehende Einsätze</h2>
                        <button data-page="missions" class="text-sm text-ios-primary hover:text-ios-primary/80 font-medium">
                            Alle ansehen →
                        </button>
                    </div>
                    
                    <div id="upcomingMissions" class="space-y-3">
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-calendar-alt text-3xl mb-3"></i>
                            <p>Keine bevorstehenden Einsätze</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Missions Page -->
            <div id="missionsPage" class="page hidden">
                <!-- Content bleibt gleich -->
            </div>

            <!-- Personnel Page -->
            <div id="personnelPage" class="page hidden">
                <!-- Content bleibt gleich -->
            </div>

            <!-- NEU: Visitors Page -->
            <div id="visitorsPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Besucher</h1>
                    <p class="text-ios-text-secondary">Aktive Besucherausweise</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <div class="mb-6">
                        <div class="flex justify-between items-center">
                            <h2 class="text-lg font-bold">Besucherausweise</h2>
                            <button id="requestVisitorBtn" class="bg-blue-600 text-white px-4 py-2 rounded-ios-sm font-semibold hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Ausweis beantragen
                            </button>
                        </div>
                        <p class="text-sm text-ios-text-secondary mt-2">
                            Hier finden Sie alle aktiven Besucherausweise. Nur gültige Ausweise werden angezeigt.
                        </p>
                    </div>
                    
                    <!-- Visitor List -->
                    <div id="visitorsList" class="space-y-4">
                        <!-- Visitors will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Management Page -->
            <div id="managementPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Management</h1>
                    <p class="text-ios-text-secondary">Leitungsebene - Systemverwaltung</p>
                </div>
                
                <!-- Quick Actions -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <button id="createMissionBtn2" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center mb-3">
                            <i class="fas fa-plus text-blue-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Neuer Einsatz</h3>
                        <p class="text-sm text-ios-text-secondary">Einsatz erstellen und planen</p>
                    </button>
                    
                    <button data-page="applications" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-green-100 flex items-center justify-center mb-3">
                            <i class="fas fa-file-alt text-green-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Bewerbungen</h3>
                        <p class="text-sm text-ios-text-secondary">
                            <span id="pendingAppsCount2" class="font-semibold">0</span> ausstehend
                        </p>
                    </button>
                    
                    <button data-page="visitorRequests" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-purple-100 flex items-center justify-center mb-3">
                            <i class="fas fa-id-card text-purple-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Besucher-Anfragen</h3>
                        <p class="text-sm text-ios-text-secondary">
                            <span id="pendingVisitorCount" class="font-semibold">0</span> ausstehend
                        </p>
                    </button>
                    
                    <button id="createUserBtn" class="ios-card rounded-ios-lg p-4 text-left hover:shadow-lg transition-shadow">
                        <div class="w-10 h-10 rounded-lg bg-orange-100 flex items-center justify-center mb-3">
                            <i class="fas fa-user-plus text-orange-600"></i>
                        </div>
                        <h3 class="font-bold mb-1">Neuer Account</h3>
                        <p class="text-sm text-ios-text-secondary">Direkt Account erstellen</p>
                    </button>
                </div>
                
                <!-- Recent Activity -->
                <div class="ios-card rounded-ios-lg p-5">
                    <h2 class="text-lg font-bold mb-4">Letzte Aktivitäten</h2>
                    <div id="managementActivity" class="space-y-3">
                        <div class="text-center py-8 text-ios-text-secondary">
                            <i class="fas fa-history text-3xl mb-3"></i>
                            <p>Keine Aktivitäten vorhanden</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Applications Page -->
            <div id="applicationsPage" class="page hidden">
                <!-- Content bleibt gleich -->
            </div>

            <!-- NEU: Visitor Requests Page -->
            <div id="visitorRequestsPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Besucher-Anfragen</h1>
                    <p class="text-ios-text-secondary">Neue Besucherausweis-Anfragen bearbeiten</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <!-- Visitor Request Tabs -->
                    <div class="flex border-b border-ios-border mb-6 -mx-5 px-5">
                        <button data-filter="pending" class="visitor-tab px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">
                            Ausstehend (<span id="pendingVisitorRequests">0</span>)
                        </button>
                        <button data-filter="accepted" class="visitor-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text">
                            Angenommen
                        </button>
                        <button data-filter="rejected" class="visitor-tab px-4 py-2 font-medium border-b-2 border-transparent text-ios-text-secondary hover:text-ios-text">
                            Abgelehnt
                        </button>
                    </div>
                    
                    <!-- Visitor Requests List -->
                    <div id="visitorRequestsList" class="space-y-4">
                        <!-- Visitor requests will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settingsPage" class="page hidden">
                <div class="mb-6">
                    <h1 class="text-2xl sm:text-3xl font-bold gradient-text">Einstellungen</h1>
                    <p class="text-ios-text-secondary">Persönliche Einstellungen</p>
                </div>
                
                <div class="ios-card rounded-ios-lg p-5">
                    <div class="space-y-6">
                        <!-- Profile Settings -->
                        <div>
                            <h2 class="text-lg font-bold mb-4">Profil</h2>
                            <div class="space-y-4 max-w-md">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Anzeigename</label>
                                    <input type="text" id="displayNameInput" 
                                           class="w-full px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                           value="Max Mustermann">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">Roblox Username</label>
                                    <input type="text" id="robloxUsername" 
                                           class="w-full px-4 py-2 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                           placeholder="Dein Roblox Name">
                                </div>
                                <button id="updateProfileBtn" class="bg-bw-green text-white px-6 py-2 rounded-ios-sm font-semibold hover:bg-green-800 transition-colors">
                                    Änderungen speichern
                                </button>
                            </div>
                        </div>
                        
                        <!-- Application Status -->
                        <div class="pt-6 border-t border-ios-border">
                            <h2 class="text-lg font-bold mb-4">Besucherausweis-Status</h2>
                            <div id="visitorStatus" class="max-w-md">
                                <!-- Visitor status will be shown here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Military ID Modal -->
    <div id="militaryIDModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <!-- Content bleibt gleich -->
    </div>

    <!-- NEU: Visitor ID Modal -->
    <div id="visitorIDModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="visitor-id rounded-ios-xl shadow-2xl w-full max-w-md p-0 overflow-hidden slide-in">
            <!-- ID Header -->
            <div class="visitor-id-header px-6 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">BUNDESWEHR RP</h2>
                        <p class="text-sm opacity-80">Besucherausweis</p>
                    </div>
                    <div class="text-right">
                        <div class="text-xs opacity-80">Besucher Nr.</div>
                        <div id="modalVisitorID" class="id-number font-mono text-sm">#VIS-0000</div>
                    </div>
                </div>
            </div>
            
            <!-- ID Content -->
            <div class="p-6">
                <div class="space-y-4">
                    <div>
                        <div class="text-xs opacity-80 mb-1">Name</div>
                        <div id="modalVisitorName" class="text-xl font-bold">-</div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs opacity-80 mb-1">Roblox Name</div>
                            <div id="modalVisitorRoblox" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-80 mb-1">Status</div>
                            <div id="modalVisitorStatus" class="px-2 py-1 rounded-full text-xs font-semibold bg-green-500">Aktiv</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="text-xs opacity-80 mb-1">Besucher-ID</div>
                        <div id="modalVisitorFullID" class="font-mono">VIS-<span id="modalVisitorNumber">0000</span></div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <div class="text-xs opacity-80 mb-1">Ausgestellt am</div>
                            <div id="modalVisitorIssued" class="font-semibold">-</div>
                        </div>
                        <div>
                            <div class="text-xs opacity-80 mb-1">Gültig bis</div>
                            <div id="modalVisitorValidUntil" class="font-semibold">-</div>
                        </div>
                    </div>
                    
                    <div>
                        <div class="text-xs opacity-80 mb-1">Berechtigungen</div>
                        <div class="text-sm">Zugang zu öffentlichen Bereichen der Kaserne</div>
                    </div>
                    
                    <div class="mt-6 pt-4 border-t border-white/10">
                        <div class="text-xs opacity-80 mb-2">Unterschrift des Kommandanten</div>
                        <div class="h-8 border-b border-white/30"></div>
                    </div>
                </div>
            </div>
            
            <!-- ID Footer -->
            <div class="px-6 py-3 bg-black/20 text-center text-xs opacity-80">
                Dieser Ausweis ist Eigentum der Bundeswehr RP und berechtigt nur zu den angegebenen Bereichen.
            </div>
            
            <!-- Close Button -->
            <button id="closeVisitorModal" class="absolute top-4 right-4 text-white/70 hover:text-white">
                <i class="fas fa-times text-xl"></i>
            </button>
        </div>
    </div>

    <!-- Accept Visitor Modal -->
    <div id="acceptVisitorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Besucherausweis genehmigen</h2>
                    <button id="closeAcceptVisitorModal" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div id="acceptVisitorInfo">
                        <!-- Visitor info will be loaded here -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Gültig bis (Datum) *</label>
                        <input type="date" id="visitorValidUntil" 
                               class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Bemerkungen</label>
                        <textarea id="visitorNotes" rows="3" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Zusätzliche Informationen..."></textarea>
                    </div>
                    
                    <div id="visitorAcceptError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte gib ein Gültigkeitsdatum an</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button id="acceptVisitorConfirmBtn" class="flex-1 bg-green-600 text-white py-3 rounded-ios-sm font-semibold hover:bg-green-700">
                            <i class="fas fa-check mr-2"></i>Genehmigen
                        </button>
                        <button id="cancelVisitorBtn" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Reject Visitor Modal -->
    <div id="rejectVisitorModal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-50 flex items-center justify-center p-4">
        <div class="ios-card rounded-ios-xl shadow-ios-xl w-full max-w-md slide-in">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold gradient-text">Besucherausweis ablehnen</h2>
                    <button id="closeRejectVisitorModal" class="text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <div id="rejectVisitorInfo">
                        <!-- Visitor info will be loaded here -->
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-2">Ablehnungsgrund *</label>
                        <textarea id="rejectVisitorReason" rows="3" 
                                  class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                  placeholder="Bitte gib einen Grund für die Ablehnung an..."></textarea>
                    </div>
                    
                    <div id="visitorRejectError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm">
                        <i class="fas fa-exclamation-circle mr-2"></i>
                        <span>Bitte gib einen Ablehnungsgrund an</span>
                    </div>
                    
                    <div class="flex gap-4 pt-4">
                        <button id="rejectVisitorConfirmBtn" class="flex-1 bg-red-600 text-white py-3 rounded-ios-sm font-semibold hover:bg-red-700">
                            <i class="fas fa-times mr-2"></i>Ablehnen
                        </button>
                        <button id="cancelVisitorRejectBtn" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                            Abbrechen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[60] flex items-center justify-center">
        <div class="ios-card rounded-ios-xl p-8 flex flex-col items-center">
            <div class="spinner mb-4"></div>
            <p class="font-semibold">Lade...</p>
        </div>
    </div>

    <!-- Notifications Container -->
    <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-3 w-80 sm:w-96"></div>

    <!-- Main JavaScript -->
    <script>
        // ======================
        // SUPABASE INITIALISIERUNG - KORRIGIERT
        // ======================
        const supabaseUrl = 'https://bxgkgqnoebjoshkuaidq.supabase.co';
        const supabaseAnonKey = 'sb_publishable_Qd2vCzcC7XJZaND_GmD8rA_mVlYGYRn';
        
        // Supabase Client erstellen - KEINE Doppeldeklaration
        const supabase = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
        
        console.log('Supabase Client initialisiert:', supabase);

        // ======================
        // APP STATE & CONFIGURATION
        // ======================
        const APP_CONFIG = {
            appName: 'Bundeswehr RP',
            version: '1.0.0',
            localStoragePrefix: 'bw_rp_',
            defaultStamina: 0,
            applicationCooldown: 7 * 24 * 60 * 60 * 1000, // 7 Tage
            ranks: [
                'Schütze', 'Gefreiter', 'Obergefreiter', 'Hauptgefreiter',
                'Stabsgefreiter', 'Oberstabsgefreiter', 'Unteroffizier',
                'Stabsunteroffizier', 'Feldwebel', 'Hauptfeldwebel',
                'Stabsfeldwebel', 'Oberstabsfeldwebel', 'Leutnant',
                'Oberleutnant', 'Hauptmann', 'Stabshauptmann', 'Major',
                'Oberstleutnant', 'Oberst', 'Brigadegeneral',
                'Generalmajor', 'Generalleutnant', 'General'
            ],
            divisions: ['Heer', 'Marine', 'Luftwaffe', 'Sanitätsdienst']
        };

        // App State
        let currentUser = null;
        let currentPage = 'dashboard';
        let missions = [];
        let personnel = [];
        let applications = [];
        let visitors = [];
        let visitorRequests = [];
        let isSidebarCollapsed = false;
        let currentAcceptVisitorId = null;
        let currentRejectVisitorId = null;
        let currentSoldierId = null;

        // ======================
        // INITIALIZATION
        // ======================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing app...');
            initializeApp();
        });

        async function initializeApp() {
            // Check for saved session
            await checkSavedSession();
            
            // Initialize clock
            updateClock();
            setInterval(updateClock, 60000);
            
            // Setup event listeners
            setupEventListeners();
            
            // Show welcome message
            setTimeout(() => {
                if (!currentUser) {
                    showNotification('Willkommen beim Bundeswehr RP System', 'info');
                }
            }, 1000);
        }

        async function checkSavedSession() {
            const savedUser = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'user');
            const savedToken = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'token');
            
            if (savedUser && savedToken) {
                try {
                    const user = JSON.parse(savedUser);
                    
                    // Check if token is still valid (simplified)
                    const tokenExpiry = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                    if (tokenExpiry && Date.now() < parseInt(tokenExpiry)) {
                        // Auto-login
                        await handleLoginSuccess(user);
                        showNotification('Willkommen zurück, ' + user.display_name, 'success');
                        return true;
                    } else {
                        // Token expired
                        localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token');
                        localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                    }
                } catch (e) {
                    console.error('Error parsing saved user:', e);
                }
            }
            
            return false;
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Login button
            document.getElementById('loginButton').addEventListener('click', login);
            
            // Application button
            document.getElementById('applicationButton').addEventListener('click', showApplicationForm);
            
            // NEU: Visitor button
            document.getElementById('visitorButton').addEventListener('click', showVisitorForm);
            
            // Back to login buttons
            document.getElementById('backToLoginButton').addEventListener('click', showLoginForm);
            document.getElementById('backToLoginButton2')?.addEventListener('click', showLoginForm);
            
            // Sidebar toggle
            document.getElementById('sidebarToggle').addEventListener('click', toggleSidebar);
            
            // Logout button
            document.getElementById('logoutButton').addEventListener('click', logout);
            
            // Show ID buttons
            document.getElementById('showIDButton').addEventListener('click', showMilitaryID);
            document.getElementById('showIDButton2').addEventListener('click', showMilitaryID);
            document.getElementById('closeIDModal').addEventListener('click', hideMilitaryID);
            
            // NEU: Visitor ID modal
            document.getElementById('closeVisitorModal').addEventListener('click', hideVisitorIDModal);
            
            // NEU: Request visitor button
            document.getElementById('requestVisitorBtn')?.addEventListener('click', showVisitorFormFromApp);
            
            // Navigation buttons
            document.querySelectorAll('.nav-item[data-page]').forEach(button => {
                button.addEventListener('click', function() {
                    showPage(this.getAttribute('data-page'));
                });
            });
            
            // NEU: Visitor request tabs
            document.querySelectorAll('.visitor-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    setVisitorRequestFilter(this.getAttribute('data-filter'));
                });
            });
            
            // Login form enter key
            document.getElementById('loginUsername')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            document.getElementById('loginPassword')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') login();
            });
            
            console.log('Event listeners set up successfully');
        }

        // ======================
        // AUTHENTICATION - KORRIGIERT
        // ======================
        async function login() {
            console.log('Login function called');
            
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            console.log('Username:', username);
            console.log('Password:', password ? '***' : 'empty');
            
            if (!username || !password) {
                showError('loginError', 'Bitte Benutzername und Passwort eingeben');
                return;
            }
            
            showLoading();
            
            try {
                console.log('Querying Supabase for user:', username);
                
                // User aus Supabase holen - PASSEND ZU UNSERER TABELLENSTRUKTUR
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('username', username)
                    .eq('password', password)
                    .limit(1);
                
                console.log('Supabase response:', { data: users, error });
                
                if (error) {
                    console.error('Supabase error:', error);
                    throw new Error('Datenbankfehler: ' + error.message);
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    console.log('User found:', user);
                    
                    // Create session
                    const token = 'supabase_token_' + Date.now();
                    const tokenExpiry = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days
                    
                    // Store session
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'user', JSON.stringify(user));
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'token', token);
                    localStorage.setItem(APP_CONFIG.localStoragePrefix + 'token_expiry', tokenExpiry.toString());
                    
                    // Handle login success
                    await handleLoginSuccess(user);
                    hideError('loginError');
                    
                    showNotification('Erfolgreich eingeloggt', 'success');
                } else {
                    console.log('No user found or password incorrect');
                    throw new Error('Falscher Benutzername oder Passwort');
                }
            } catch (error) {
                console.error('Login error:', error);
                showError('loginError', error.message);
            } finally {
                hideLoading();
            }
        }

        async function handleLoginSuccess(user) {
            console.log('Login success for user:', user);
            currentUser = user;
            
            // Update UI
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            
            // Update user display
            updateUserDisplay(user);
            
            // Check permissions
            checkPermissions(user.role);
            
            // Load initial data from Supabase
            await Promise.all([
                loadDashboard(),
                loadVisitors(),
                loadVisitorRequests()
            ]);
            
            // Show dashboard
            showPage('dashboard');
        }

        function logout() {
            if (confirm('Möchtest du dich wirklich ausloggen?')) {
                // Clear session
                localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token');
                localStorage.removeItem(APP_CONFIG.localStoragePrefix + 'token_expiry');
                
                // Reset UI
                currentUser = null;
                document.getElementById('mainApp').classList.add('hidden');
                document.getElementById('loginScreen').classList.remove('hidden');
                
                // Clear forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                hideError('loginError');
                
                showNotification('Erfolgreich ausgeloggt', 'info');
            }
        }

        // ======================
        // VISITOR SYSTEM - NEUE FUNKTIONEN
        // ======================
        function showVisitorForm() {
            document.getElementById('loginScreen').classList.add('hidden');
            document.getElementById('visitorForm').classList.remove('hidden');
            
            const content = `
                <form id="visitorFormElement">
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium mb-2">Roblox Display Name *</label>
                            <input type="text" id="visitorDisplayName" required
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                   placeholder="Dein Roblox Display Name">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Roblox Username *</label>
                            <input type="text" id="visitorRobloxUsername" required
                                   class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                   placeholder="@username">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">Grund des Besuchs *</label>
                            <textarea id="visitorReason" rows="4" required
                                      class="w-full px-4 py-3 rounded-ios-sm border border-ios-border focus:outline-none focus:border-ios-primary focus:ring-2 focus:ring-ios-primary/20"
                                      placeholder="Warum benötigst du einen Besucherausweis?"></textarea>
                        </div>
                        
                        <div id="visitorFormError" class="hidden bg-red-50 border border-red-200 text-red-600 p-3 rounded-ios-sm"></div>
                        
                        <div class="flex gap-4 pt-4">
                            <button type="submit" class="flex-1 bg-blue-600 text-white py-3 rounded-ios-sm font-semibold hover:bg-blue-700">
                                <i class="fas fa-paper-plane mr-2"></i>Antrag absenden
                            </button>
                            <button type="button" id="cancelVisitorFormBtn" class="flex-1 bg-white border border-ios-primary text-ios-primary py-3 rounded-ios-sm font-semibold hover:bg-ios-primary/10">
                                Abbrechen
                            </button>
                        </div>
                        
                        <p class="text-sm text-ios-text-secondary text-center">
                            <i class="fas fa-info-circle mr-1"></i>
                            Dein Antrag wird von der Leitung geprüft. Du wirst per Roblox benachrichtigt.
                        </p>
                    </div>
                </form>
            `;
            
            document.getElementById('visitorContent').innerHTML = content;
            
            // Add event listeners
            document.getElementById('visitorFormElement').addEventListener('submit', function(event) {
                event.preventDefault();
                submitVisitorRequest();
            });
            
            document.getElementById('cancelVisitorFormBtn').addEventListener('click', showLoginForm);
        }

        function showVisitorFormFromApp() {
            showNotification('Bitte logge dich aus, um einen Besucherausweis zu beantragen', 'info');
            setTimeout(() => {
                logout();
                setTimeout(() => {
                    document.getElementById('visitorButton').click();
                }, 500);
            }, 1000);
        }

        async function submitVisitorRequest() {
            const displayName = document.getElementById('visitorDisplayName').value;
            const robloxUsername = document.getElementById('visitorRobloxUsername').value;
            const reason = document.getElementById('visitorReason').value;
            
            if (!displayName || !robloxUsername || !reason) {
                document.getElementById('visitorFormError').textContent = 'Bitte fülle alle Felder aus';
                document.getElementById('visitorFormError').classList.remove('hidden');
                return;
            }
            
            try {
                // Generate visitor ID
                const { data: lastVisitor } = await supabase
                    .from('visitor_requests')
                    .select('visitor_id')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let nextId = 1000;
                if (lastVisitor && lastVisitor[0] && lastVisitor[0].visitor_id) {
                    const lastId = parseInt(lastVisitor[0].visitor_id.split('-')[1]);
                    nextId = lastId + 1;
                }
                
                const visitorId = 'VIS-' + nextId.toString().padStart(4, '0');
                
                const visitorRequest = {
                    visitor_id: visitorId,
                    display_name: displayName,
                    roblox_username: robloxUsername,
                    reason: reason,
                    status: 'pending',
                    created_at: new Date().toISOString(),
                    request_date: new Date().toLocaleDateString('de-DE')
                };
                
                const { data, error } = await supabase
                    .from('visitor_requests')
                    .insert([visitorRequest]);
                
                if (error) throw error;
                
                // Store locally for status checking
                localStorage.setItem(APP_CONFIG.localStoragePrefix + 'last_visitor_request', JSON.stringify(visitorRequest));
                localStorage.setItem(APP_CONFIG.localStoragePrefix + 'visitor_status', 'pending');
                
                showNotification('Besucherausweis-Anfrage erfolgreich eingereicht!', 'success');
                
                setTimeout(() => {
                    showLoginForm();
                    showNotification('Die Leitung wird deinen Antrag prüfen.', 'info');
                }, 1500);
                
            } catch (error) {
                console.error('Error submitting visitor request:', error);
                showNotification('Fehler beim Einreichen der Anfrage', 'error');
            }
        }

        async function loadVisitors() {
            try {
                const today = new Date().toISOString().split('T')[0];
                
                const { data: visitorsData, error } = await supabase
                    .from('visitor_requests')
                    .select('*')
                    .eq('status', 'accepted')
                    .gte('valid_until', today) // Nur gültige Ausweise
                    .order('valid_until', { ascending: true });
                
                if (error) throw error;
                
                visitors = visitorsData || [];
                
                // Update UI
                const container = document.getElementById('visitorsList');
                if (container) {
                    renderVisitors(visitors, container);
                }
                
                return visitors;
            } catch (error) {
                console.error('Error loading visitors:', error);
                showNotification('Fehler beim Laden der Besucher', 'error');
                return [];
            }
        }

        async function loadVisitorRequests(filter = 'pending') {
            try {
                let query = supabase
                    .from('visitor_requests')
                    .select('*');
                
                if (filter !== 'all') {
                    query = query.eq('status', filter);
                }
                
                const { data: requests, error } = await query;
                
                if (error) throw error;
                
                visitorRequests = requests || [];
                
                // Update counts
                const pendingCount = visitorRequests.filter(req => req.status === 'pending').length;
                document.getElementById('pendingVisitorRequests').textContent = pendingCount;
                document.getElementById('pendingVisitorCount').textContent = pendingCount;
                
                const pendingVisitorBadge = document.getElementById('pendingVisitorBadge');
                if (pendingVisitorBadge) {
                    pendingVisitorBadge.textContent = pendingCount;
                    pendingVisitorBadge.classList.toggle('hidden', pendingCount === 0);
                }
                
                // Update UI
                const container = document.getElementById('visitorRequestsList');
                if (container) {
                    renderVisitorRequests(visitorRequests, container);
                }
                
                return visitorRequests;
            } catch (error) {
                console.error('Error loading visitor requests:', error);
                showNotification('Fehler beim Laden der Besucher-Anfragen', 'error');
                return [];
            }
        }

        function renderVisitors(visitors, container) {
            if (visitors.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-ios-text-secondary">
                        <i class="fas fa-user-tag text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Keine aktiven Besucherausweise</p>
                        <p class="text-sm">Es sind keine gültigen Besucherausweise vorhanden.</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            visitors.forEach(visitor => {
                const validUntil = new Date(visitor.valid_until);
                const today = new Date();
                const daysLeft = Math.ceil((validUntil - today) / (1000 * 60 * 60 * 24));
                
                html += `
                    <div class="border border-ios-border rounded-ios-sm p-5 hover:shadow-md transition-shadow">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg">${visitor.display_name}</h3>
                                <p class="text-ios-text-secondary">
                                    <i class="fab fa-roblox mr-1"></i>${visitor.roblox_username}
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-id-card mr-1"></i>${visitor.visitor_id}
                                </p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                daysLeft < 3 ? 'bg-red-100 text-red-800' :
                                daysLeft < 7 ? 'bg-yellow-100 text-yellow-800' :
                                'bg-green-100 text-green-800'
                            }">
                                Gültig: ${daysLeft} Tag${daysLeft !== 1 ? 'e' : ''}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm font-medium mb-2">Grund:</p>
                            <div class="bg-gray-50 p-3 rounded-ios-sm">${visitor.reason}</div>
                        </div>
                        
                        <div class="flex justify-between items-center pt-4 border-t border-ios-border">
                            <div class="text-ios-text-secondary text-sm">
                                <i class="fas fa-calendar-alt mr-1"></i>
                                Gültig bis: ${validUntil.toLocaleDateString('de-DE')}
                            </div>
                            <button data-visitor-id="${visitor.id}" class="view-visitor-btn text-blue-600 hover:text-blue-800 font-medium">
                                <i class="fas fa-eye mr-1"></i>Ausweis ansehen
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add event listeners
            container.querySelectorAll('.view-visitor-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const visitorId = this.getAttribute('data-visitor-id');
                    showVisitorID(visitorId);
                });
            });
        }

        function renderVisitorRequests(requests, container) {
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-ios-text-secondary">
                        <i class="fas fa-id-card text-4xl mb-4"></i>
                        <p class="text-lg mb-2">Keine ${filter === 'pending' ? 'ausstehenden' : filter === 'accepted' ? 'angenommenen' : 'abgelehnten'} Anfragen</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            requests.forEach(request => {
                html += `
                    <div class="border border-ios-border rounded-ios-sm p-5">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-lg">${request.display_name}</h3>
                                <p class="text-ios-text-secondary">
                                    <i class="fab fa-roblox mr-1"></i>${request.roblox_username}
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-calendar-alt mr-1"></i>${request.request_date}
                                    <span class="mx-2">•</span>
                                    <i class="fas fa-id-card mr-1"></i>${request.visitor_id}
                                </p>
                            </div>
                            <span class="px-3 py-1 rounded-full text-sm font-semibold ${
                                request.status === 'pending' ? 'status-pending' :
                                request.status === 'accepted' ? 'status-accepted' :
                                'status-rejected'
                            }">
                                ${request.status === 'pending' ? 'Ausstehend' :
                                  request.status === 'accepted' ? 'Angenommen' : 'Abgelehnt'}
                            </span>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm font-medium mb-2">Grund des Besuchs:</p>
                            <div class="bg-gray-50 p-3 rounded-ios-sm">${request.reason}</div>
                        </div>
                        
                        ${request.status === 'pending' && (currentUser?.role === 'admin' || currentUser?.role === 'leader') ? `
                            <div class="flex gap-3 pt-4 border-t border-ios-border">
                                <button data-request-id="${request.id}" class="accept-visitor-btn flex-1 bg-green-600 text-white py-2 rounded-ios-sm font-semibold hover:bg-green-700">
                                    <i class="fas fa-check mr-2"></i>Genehmigen
                                </button>
                                <button data-request-id="${request.id}" class="reject-visitor-btn flex-1 bg-red-600 text-white py-2 rounded-ios-sm font-semibold hover:bg-red-700">
                                    <i class="fas fa-times mr-2"></i>Ablehnen
                                </button>
                            </div>
                        ` : ''}
                        
                        ${request.status === 'accepted' ? `
                            <div class="bg-green-50 border border-green-200 rounded-ios-sm p-3 mt-3">
                                <p class="font-medium text-green-800 mb-1">Besucherausweis genehmigt</p>
                                <p class="text-sm text-green-600">Gültig bis: ${new Date(request.valid_until).toLocaleDateString('de-DE')}</p>
                                ${request.notes ? `<p class="text-sm text-green-600 mt-1">Bemerkungen: ${request.notes}</p>` : ''}
                            </div>
                        ` : ''}
                        
                        ${request.status === 'rejected' && request.rejection_reason ? `
                            <div class="bg-red-50 border border-red-200 rounded-ios-sm p-3 mt-3">
                                <p class="font-medium text-red-800 mb-1">Abgelehnt</p>
                                <p class="text-sm text-red-600">Grund: ${request.rejection_reason}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            // Add event listeners
            container.querySelectorAll('.accept-visitor-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const requestId = this.getAttribute('data-request-id');
                    showAcceptVisitorModal(requestId);
                });
            });
            
            container.querySelectorAll('.reject-visitor-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const requestId = this.getAttribute('data-request-id');
                    showRejectVisitorModal(requestId);
                });
            });
        }

        function showAcceptVisitorModal(requestId) {
            const request = visitorRequests.find(r => r.id === requestId);
            if (!request) return;
            
            // Set minimum date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDate = tomorrow.toISOString().split('T')[0];
            
            document.getElementById('visitorValidUntil').min = minDate;
            document.getElementById('visitorValidUntil').value = minDate;
            
            document.getElementById('acceptVisitorInfo').innerHTML = `
                <div class="bg-gray-50 p-3 rounded-ios-sm mb-4">
                    <p class="font-medium">${request.display_name}</p>
                    <p class="text-sm text-ios-text-secondary">Roblox: ${request.roblox_username}</p>
                    <p class="text-sm text-ios-text-secondary">ID: ${request.visitor_id}</p>
                    <p class="text-sm text-ios-text-secondary mt-2">Grund: ${request.reason}</p>
                </div>
            `;
            
            document.getElementById('acceptVisitorModal').classList.remove('hidden');
            currentAcceptVisitorId = requestId;
            
            // Add event listeners for modal buttons
            document.getElementById('acceptVisitorConfirmBtn').onclick = acceptVisitorConfirm;
            document.getElementById('cancelVisitorBtn').onclick = hideAcceptVisitorModal;
            document.getElementById('closeAcceptVisitorModal').onclick = hideAcceptVisitorModal;
        }

        function hideAcceptVisitorModal() {
            document.getElementById('acceptVisitorModal').classList.add('hidden');
            document.getElementById('visitorAcceptError').classList.add('hidden');
            currentAcceptVisitorId = null;
        }

        async function acceptVisitorConfirm() {
            const validUntil = document.getElementById('visitorValidUntil').value;
            const notes = document.getElementById('visitorNotes').value;
            
            if (!validUntil) {
                document.getElementById('visitorAcceptError').classList.remove('hidden');
                return;
            }
            
            try {
                const request = visitorRequests.find(r => r.id === currentAcceptVisitorId);
                if (!request) return;
                
                const { error } = await supabase
                    .from('visitor_requests')
                    .update({ 
                        status: 'accepted',
                        valid_until: validUntil,
                        notes: notes,
                        reviewed_by: currentUser.id,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', currentAcceptVisitorId);
                
                if (error) throw error;
                
                hideAcceptVisitorModal();
                showNotification('Besucherausweis genehmigt', 'success');
                
                await Promise.all([
                    loadVisitorRequests(),
                    loadVisitors()
                ]);
                
            } catch (error) {
                console.error('Error accepting visitor request:', error);
                showNotification('Fehler beim Genehmigen des Ausweises', 'error');
            }
        }

        function showRejectVisitorModal(requestId) {
            const request = visitorRequests.find(r => r.id === requestId);
            if (!request) return;
            
            document.getElementById('rejectVisitorInfo').innerHTML = `
                <div class="bg-gray-50 p-3 rounded-ios-sm mb-4">
                    <p class="font-medium">${request.display_name}</p>
                    <p class="text-sm text-ios-text-secondary">Roblox: ${request.roblox_username}</p>
                    <p class="text-sm text-ios-text-secondary">ID: ${request.visitor_id}</p>
                </div>
            `;
            
            document.getElementById('rejectVisitorModal').classList.remove('hidden');
            currentRejectVisitorId = requestId;
            
            // Add event listeners
            document.getElementById('rejectVisitorConfirmBtn').onclick = rejectVisitorConfirm;
            document.getElementById('cancelVisitorRejectBtn').onclick = hideRejectVisitorModal;
            document.getElementById('closeRejectVisitorModal').onclick = hideRejectVisitorModal;
        }

        function hideRejectVisitorModal() {
            document.getElementById('rejectVisitorModal').classList.add('hidden');
            document.getElementById('visitorRejectError').classList.add('hidden');
            currentRejectVisitorId = null;
        }

        async function rejectVisitorConfirm() {
            const reason = document.getElementById('rejectVisitorReason').value;
            
            if (!reason) {
                document.getElementById('visitorRejectError').classList.remove('hidden');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('visitor_requests')
                    .update({ 
                        status: 'rejected',
                        rejection_reason: reason,
                        reviewed_by: currentUser.id,
                        reviewed_at: new Date().toISOString()
                    })
                    .eq('id', currentRejectVisitorId);
                
                if (error) throw error;
                
                hideRejectVisitorModal();
                showNotification('Besucherausweis abgelehnt', 'info');
                
                await loadVisitorRequests();
                
            } catch (error) {
                console.error('Error rejecting visitor request:', error);
                showNotification('Fehler beim Ablehnen des Ausweises', 'error');
            }
        }

        function showVisitorID(visitorId) {
            const visitor = visitors.find(v => v.id === visitorId);
            if (!visitor) return;
            
            document.getElementById('modalVisitorName').textContent = visitor.display_name;
            document.getElementById('modalVisitorRoblox').textContent = visitor.roblox_username;
            document.getElementById('modalVisitorFullID').textContent = visitor.visitor_id;
            document.getElementById('modalVisitorID').textContent = visitor.visitor_id;
            
            const visitorIdParts = visitor.visitor_id.split('-');
            document.getElementById('modalVisitorNumber').textContent = visitorIdParts.length > 1 ? visitorIdParts[1] : '0000';
            
            if (visitor.created_at) {
                const issuedDate = new Date(visitor.created_at);
                document.getElementById('modalVisitorIssued').textContent = issuedDate.toLocaleDateString('de-DE');
            }
            
            if (visitor.valid_until) {
                const validUntil = new Date(visitor.valid_until);
                document.getElementById('modalVisitorValidUntil').textContent = validUntil.toLocaleDateString('de-DE');
                
                const today = new Date();
                const isExpired = validUntil < today;
                const statusEl = document.getElementById('modalVisitorStatus');
                statusEl.textContent = isExpired ? 'Abgelaufen' : 'Aktiv';
                statusEl.className = isExpired ? 
                    'px-2 py-1 rounded-full text-xs font-semibold bg-red-500' : 
                    'px-2 py-1 rounded-full text-xs font-semibold bg-green-500';
            }
            
            document.getElementById('visitorIDModal').classList.remove('hidden');
        }

        function hideVisitorIDModal() {
            document.getElementById('visitorIDModal').classList.add('hidden');
        }

        // ======================
        // HELPER FUNCTIONS
        // ======================
        function updateClock() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('de-DE', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            const dateStr = now.toLocaleDateString('de-DE', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            const timeEl = document.getElementById('currentTime');
            const dateEl = document.getElementById('currentDate');
            
            if (timeEl) timeEl.textContent = timeStr;
            if (dateEl) dateEl.textContent = dateStr;
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            isSidebarCollapsed = !isSidebarCollapsed;
            
            if (isSidebarCollapsed) {
                sidebar.classList.remove('sidebar-expanded');
                sidebar.classList.add('sidebar-collapsed');
                mainContent.classList.remove('main-expanded');
                mainContent.classList.add('main-collapsed');
                
                sidebar.querySelectorAll('span:not(.absolute)').forEach(span => {
                    if (!span.closest('#userID')) {
                        span.classList.add('hidden');
                    }
                });
            } else {
                sidebar.classList.remove('sidebar-collapsed');
                sidebar.classList.add('sidebar-expanded');
                mainContent.classList.remove('main-collapsed');
                mainContent.classList.add('main-expanded');
                
                sidebar.querySelectorAll('span').forEach(span => {
                    span.classList.remove('hidden');
                });
            }
        }

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            const pageElement = document.getElementById(page + 'Page');
            if (pageElement) {
                pageElement.classList.remove('hidden');
            }
            
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('bg-gray-50', 'text-ios-primary');
            });
            
            // Load page data if needed
            if (page === 'dashboard') loadDashboard();
            if (page === 'visitors') loadVisitors();
            if (page === 'visitorRequests') loadVisitorRequests();
            
            currentPage = page;
        }

        function setVisitorRequestFilter(filter) {
            document.querySelectorAll('.visitor-tab').forEach(tab => {
                tab.classList.remove('border-b-2', 'border-blue-600', 'text-blue-600');
                tab.classList.add('border-transparent', 'text-ios-text-secondary');
            });
            
            const activeTab = document.querySelector(`.visitor-tab[data-filter="${filter}"]`);
            if (activeTab) {
                activeTab.classList.add('border-b-2', 'border-blue-600', 'text-blue-600');
                activeTab.classList.remove('border-transparent', 'text-ios-text-secondary');
            }
            
            loadVisitorRequests(filter);
        }

        function showLoginForm() {
            document.getElementById('applicationForm').classList.add('hidden');
            document.getElementById('visitorForm').classList.add('hidden');
            document.getElementById('loginScreen').classList.remove('hidden');
        }

        function updateUserDisplay(user) {
            const initials = user.display_name.split(' ').map(n => n[0]).join('').toUpperCase();
            document.getElementById('userAvatar').textContent = initials.substring(0, 2);
            document.getElementById('userInitials').textContent = initials.substring(0, 2);
            
            document.getElementById('userDisplayName').textContent = user.display_name;
            document.getElementById('userName').textContent = user.display_name;
            document.getElementById('userRank').textContent = user.rank;
            document.getElementById('userRankSmall').textContent = `Rang: ${user.rank}`;
            document.getElementById('userDivision').textContent = `Division: ${user.division}`;
            document.getElementById('userID').textContent = user.soldier_id;
            
            document.getElementById('staminaValue').textContent = user.stamina;
            document.getElementById('dashboardStamina').textContent = user.stamina;
            
            document.getElementById('idName').textContent = user.display_name;
            document.getElementById('idRank').textContent = user.rank;
            document.getElementById('idUnit').textContent = user.division;
            document.getElementById('idNumber').textContent = user.soldier_id;
            
            if (user.service_start) {
                const startDate = new Date(user.service_start);
                const now = new Date();
                const months = (now.getFullYear() - startDate.getFullYear()) * 12 + 
                              (now.getMonth() - startDate.getMonth());
                document.getElementById('serviceTime').textContent = `${months} Monat${months !== 1 ? 'e' : ''}`;
                document.getElementById('idStartDate').textContent = new Date(user.service_start).toLocaleDateString('de-DE');
            }
        }

        function checkPermissions(role) {
            const managementSection = document.getElementById('managementSection');
            
            if (role === 'admin' || role === 'leader') {
                if (managementSection) managementSection.classList.remove('hidden');
            } else {
                if (managementSection) managementSection.classList.add('hidden');
            }
        }

        async function loadDashboard() {
            if (!currentUser) return;
            
            // Update user display
            updateUserDisplay(currentUser);
            
            // Load visitor status in settings
            await loadVisitorStatus();
        }

        async function loadVisitorStatus() {
            const statusContainer = document.getElementById('visitorStatus');
            if (!statusContainer) return;
            
            const lastVisitorRequest = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'last_visitor_request');
            const visitorStatus = localStorage.getItem(APP_CONFIG.localStoragePrefix + 'visitor_status');
            
            if (lastVisitorRequest && visitorStatus) {
                try {
                    const request = JSON.parse(lastVisitorRequest);
                    
                    let statusText = '';
                    let statusClass = '';
                    let statusIcon = '';
                    
                    switch(visitorStatus) {
                        case 'pending':
                            statusText = 'In Bearbeitung';
                            statusClass = 'status-pending';
                            statusIcon = 'fa-clock';
                            break;
                        case 'accepted':
                            statusText = 'Genehmigt';
                            statusClass = 'status-accepted';
                            statusIcon = 'fa-check-circle';
                            break;
                        case 'rejected':
                            statusText = 'Abgelehnt';
                            statusClass = 'status-rejected';
                            statusIcon = 'fa-times-circle';
                            break;
                    }
                    
                    statusContainer.innerHTML = `
                        <div class="p-4 rounded-ios-sm ${statusClass}">
                            <div class="flex items-center gap-3">
                                <i class="fas ${statusIcon} text-xl"></i>
                                <div>
                                    <p class="font-medium">Besucherausweis-Status: ${statusText}</p>
                                    <p class="text-sm mt-1">ID: ${request.visitor_id}</p>
                                    <p class="text-sm mt-1">Eingereicht am: ${request.request_date}</p>
                                    ${visitorStatus === 'accepted' && request.valid_until ? `
                                        <p class="text-sm mt-1">Gültig bis: ${new Date(request.valid_until).toLocaleDateString('de-DE')}</p>
                                    ` : ''}
                                    ${visitorStatus === 'rejected' && request.rejection_reason ? `
                                        <p class="text-sm mt-1">Grund: ${request.rejection_reason}</p>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } catch (e) {
                    console.error('Error loading visitor status:', e);
                }
            } else {
                statusContainer.innerHTML = `
                    <div class="text-center py-8 text-ios-text-secondary">
                        <i class="fas fa-id-card text-3xl mb-3"></i>
                        <p>Keine aktive Besucherausweis-Anfrage</p>
                        <button id="newVisitorRequestBtn" class="mt-4 text-blue-600 hover:text-blue-800 font-medium">
                            Besucherausweis beantragen →
                        </button>
                    </div>
                `;
                
                document.getElementById('newVisitorRequestBtn')?.addEventListener('click', function() {
                    document.getElementById('mainApp').classList.add('hidden');
                    document.getElementById('loginScreen').classList.remove('hidden');
                    setTimeout(() => {
                        document.getElementById('visitorButton').click();
                    }, 500);
                });
            }
        }

        function showMilitaryID() {
            if (!currentUser) return;
            
            // ... existing military ID code ...
        }

        function hideMilitaryID() {
            document.getElementById('militaryIDModal').classList.add('hidden');
        }

        function showError(elementId, message) {
            const element = document.getElementById(elementId);
            if (element) {
                const span = element.querySelector('span');
                if (span) {
                    span.textContent = message;
                }
                element.classList.remove('hidden');
            }
        }

        function hideError(elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.add('hidden');
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            const id = 'notif_' + Date.now();
            
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            
            const colors = {
                success: 'green',
                error: 'red',
                warning: 'yellow',
                info: 'blue'
            };
            
            const notification = document.createElement('div');
            notification.id = id;
            notification.className = `ios-card rounded-ios-sm p-4 slide-in border-l-4 border-${colors[type]}-500`;
            
            notification.innerHTML = `
                <div class="flex items-start gap-3">
                    <i class="fas fa-${icons[type]} text-${colors[type]}-500 mt-0.5"></i>
                    <div class="flex-1">
                        <p class="font-medium">${message}</p>
                    </div>
                    <button class="close-notification-btn text-ios-text-secondary hover:text-ios-text">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            notification.querySelector('.close-notification-btn').addEventListener('click', function() {
                notification.remove();
            });
            
            setTimeout(() => {
                const notif = document.getElementById(id);
                if (notif) {
                    notif.classList.add('opacity-0', 'transition-opacity', 'duration-300');
                    setTimeout(() => notif.remove(), 300);
                }
            }, 5000);
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // ======================
        // DATABASE SETUP SQL
        // ======================
        const databaseSetupSQL = `
        -- Create tables for Bundeswehr RP System
        
        -- Users table (für Login)
        CREATE TABLE IF NOT EXISTS users (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            username VARCHAR(50) UNIQUE NOT NULL,
            password VARCHAR(255) NOT NULL,
            display_name VARCHAR(100) NOT NULL,
            rank VARCHAR(50) DEFAULT 'Schütze',
            division VARCHAR(50) DEFAULT 'Heer',
            stamina INTEGER DEFAULT 0,
            role VARCHAR(20) DEFAULT 'soldier' CHECK (role IN ('soldier', 'leader', 'admin')),
            soldier_id VARCHAR(20) UNIQUE NOT NULL,
            roblox_username VARCHAR(100),
            service_start DATE DEFAULT CURRENT_DATE,
            created_at TIMESTAMP DEFAULT NOW()
        );
        
        -- Visitor requests table (NEU für Besucherausweise)
        CREATE TABLE IF NOT EXISTS visitor_requests (
            id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
            visitor_id VARCHAR(20) UNIQUE NOT NULL,
            display_name VARCHAR(100) NOT NULL,
            roblox_username VARCHAR(100) NOT NULL,
            reason TEXT NOT NULL,
            status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'rejected')),
            valid_until DATE,
            notes TEXT,
            rejection_reason TEXT,
            created_at TIMESTAMP DEFAULT NOW(),
            request_date VARCHAR(50),
            reviewed_by UUID REFERENCES users(id),
            reviewed_at TIMESTAMP
        );
        
        -- Create test admin account (password: admin123)
        INSERT INTO users (username, password, display_name, rank, division, role, soldier_id) 
        VALUES (
            'admin',
            'admin123',
            'Oberst Markus Schmidt',
            'Oberst',
            'Heer',
            'admin',
            'BW-0001'
        ) ON CONFLICT (username) DO NOTHING;
        
        -- Create test soldier account (password: soldat123)
        INSERT INTO users (username, password, display_name, rank, division, role, soldier_id) 
        VALUES (
            'soldat',
            'soldat123',
            'Gefreiter Thomas Weber',
            'Gefreiter',
            'Marine',
            'soldier',
            'BW-0002'
        ) ON CONFLICT (username) DO NOTHING;
        
        -- Test visitor request
        INSERT INTO visitor_requests (visitor_id, display_name, roblox_username, reason, status, request_date)
        VALUES (
            'VIS-1000',
            'Max Mustermann',
            'MaxMuster123',
            'Besuch der Kaserne für Information über die Bundeswehr',
            'pending',
            '${new Date().toLocaleDateString('de-DE')}'
        ) ON CONFLICT (visitor_id) DO NOTHING;
        `;

        // Make SQL available globally
        window.databaseSetupSQL = databaseSetupSQL;
        console.log('Database setup SQL available at window.databaseSetupSQL');
        
        // Debug: Check if Supabase is working
        console.log('Script fully loaded. Supabase:', supabase);
        console.log('Test credentials:');
        console.log('Admin: username=admin, password=admin123');
        console.log('Soldier: username=soldat, password=soldat123');
    </script>
</body>
</html>
